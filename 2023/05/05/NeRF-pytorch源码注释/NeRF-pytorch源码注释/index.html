

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/Github.png">
  <link rel="icon" href="/img/Github.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Ling yi">
  <meta name="keywords" content="">
  
    <meta name="description" content="个人对NeRF-pytorch源码的一些注释，侧重于python语法和整体实现过程">
<meta property="og:type" content="article">
<meta property="og:title" content="NeRF-pytorch源码注释">
<meta property="og:url" content="https://anonymouslosty.github.io/2023/05/05/NeRF-pytorch%E6%BA%90%E7%A0%81%E6%B3%A8%E9%87%8A/NeRF-pytorch%E6%BA%90%E7%A0%81%E6%B3%A8%E9%87%8A/index.html">
<meta property="og:site_name" content="anonymouslosty的Blog">
<meta property="og:description" content="个人对NeRF-pytorch源码的一些注释，侧重于python语法和整体实现过程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://anonymouslosty.github.io/img/NeRF-pytorch%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88.png">
<meta property="article:published_time" content="2023-05-05T09:14:19.000Z">
<meta property="article:modified_time" content="2023-05-06T09:35:24.970Z">
<meta property="article:author" content="Ling yi">
<meta property="article:tag" content="NeRF">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="DeepLearning">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://anonymouslosty.github.io/img/NeRF-pytorch%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>NeRF-pytorch源码注释 - anonymouslosty的Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"anonymouslosty.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":90,"cursorChar":"..","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":true,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>anonymouslosty的Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/band.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="NeRF-pytorch源码注释"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Ling yi
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-05 17:14" pubdate>
          2023年5月5日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          54k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          450 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

    <a target="_blank" rel="noopener" href="https://github.com/anonymouslosty" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0; z-index: 1031;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">NeRF-pytorch源码注释</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：1 个月前
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h4 id="主要函数调用栈"><a href="#主要函数调用栈" class="headerlink" title="主要函数调用栈"></a>主要函数调用栈</h4><p><img src="/img/NeRF-pytorch%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88.png" srcset="/img/loading.gif" lazyload alt="NeRF-pytorch函数调用栈"></p>
<h4 id="fern-txt"><a href="#fern-txt" class="headerlink" title="fern.txt"></a>fern.txt</h4><p>配置文件</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs tex">expname = fern<span class="hljs-built_in">_</span>test<br>basedir = ./logs<br>datadir = ../NeRF<span class="hljs-built_in">_</span>data/llff/fern<br>dataset<span class="hljs-built_in">_</span>type = llff<br><br>factor = 8<br>llffhold = 8<br><br>N<span class="hljs-built_in">_</span>rand = 1024<br>N<span class="hljs-built_in">_</span>coarse<span class="hljs-built_in">_</span>samples = 64<br>N<span class="hljs-built_in">_</span>fine<span class="hljs-built_in">_</span>samples = 64<br><br>use<span class="hljs-built_in">_</span>viewdirs = True<br>raw<span class="hljs-built_in">_</span>noise<span class="hljs-built_in">_</span>std = 1e0<br><br></code></pre></td></tr></table></figure>



<h4 id="run-nerf-py"><a href="#run-nerf-py" class="headerlink" title="run_nerf.py"></a>run_nerf.py</h4><p><strong>主函数，内部集成了<code>Train</code>训练函数</strong></p>
<p><em>train:</em> 训练的主函数</p>
<p><em>create_log_files:</em> 创建log文件</p>
<p><em>create_nerf:</em>  按论文的结构构造神经网络</p>
<p><em>run_network:</em> 位置编码完送，调用<em>batchify</em></p>
<p><em>batchify:</em> 把光线分批，再调用神经网络，再拼起来</p>
<p><em>run_render_only:</em> 只进行渲染</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> imageio<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span>  tqdm,trange<br><span class="hljs-keyword">from</span> opts <span class="hljs-keyword">import</span> config_parser<br><br><span class="hljs-keyword">from</span> load_llff_data <span class="hljs-keyword">import</span> load_llff_data<br><br><span class="hljs-keyword">from</span> embed <span class="hljs-keyword">import</span> get_embedder<br><span class="hljs-keyword">from</span> NeRF_model <span class="hljs-keyword">import</span>  NeRF<br><span class="hljs-keyword">from</span> render <span class="hljs-keyword">import</span> render,render_path,to8b<br><span class="hljs-keyword">from</span> rays <span class="hljs-keyword">import</span> get_rays_np<br><span class="hljs-comment">#定义训练用的device</span><br>device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)<br><br><span class="hljs-comment">#定义计算loss误差的函数</span><br>img2mse = <span class="hljs-keyword">lambda</span> x, y: torch.mean((x - y) ** <span class="hljs-number">2</span>)<br><span class="hljs-comment">#定义由mse计算psnr的函数</span><br>mse2psnr = <span class="hljs-keyword">lambda</span> x: -<span class="hljs-number">10.</span> * torch.log(x) / torch.log(torch.Tensor([<span class="hljs-number">10.</span>]))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_render_only</span>(<span class="hljs-params">args,images,i_test,basedir,expname,render_poses,hwf,K,render_kwargs_test,start</span>):<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">if</span> args.render_test():<br>            <span class="hljs-comment"># 渲染测试集</span><br>            images = images[i_test]<br>        <span class="hljs-keyword">else</span>:<br>            images=<span class="hljs-literal">None</span><br><br>        test_save_dir = os.path.join(basedir,expname,<br>                                     <span class="hljs-string">&#x27;renderonly_&#123;&#125;_&#123;:06d&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&#x27;test&#x27;</span> <span class="hljs-keyword">if</span> args.render_test <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;path&#x27;</span>,start))<br>        os.makedirs(test_save_dir,exist_ok=<span class="hljs-literal">True</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;test pose shape:&#x27;</span>,render_poses.shape)<br><br>        rgbs,_ = render_path(render_poses, hwf, K, args.chunk, render_kwargs_test,gt_images=images,<br>                             savedir=test_save_dir, render_factor=args.render_factor)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done Rendering&quot;</span>,test_save_dir)<br>        imageio.mimwrite(os.path.join(test_save_dir),<span class="hljs-string">&#x27;video.mp4&#x27;</span>,to8b(rgbs),fps=<span class="hljs-number">30</span>,quality=<span class="hljs-number">8</span>)<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">batchify</span>(<span class="hljs-params">fn,chunk</span>):<br>    <span class="hljs-comment"># 如果指定了chunk分批的大小 返回分块的函数</span><br>    <span class="hljs-comment"># 否则直接返回神经网络</span><br>    <span class="hljs-keyword">if</span> chunk <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> fn<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ret</span>(<span class="hljs-params">inputs</span>):<br>        <span class="hljs-comment">#将输入分为大小为chunk的块，送到网络fn中计算结果，然后把结果拼接起来</span><br>        <span class="hljs-keyword">return</span> torch.cat([fn(inputs[i:i + chunk]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,inputs.shape[<span class="hljs-number">0</span>],  chunk)], <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> ret<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_network</span>(<span class="hljs-params">inputs,viewdirs,fn,embed_fn,embeddirs_fn,netchunk=<span class="hljs-number">1024</span>*<span class="hljs-number">64</span></span>):<br>    <span class="hljs-comment"># [N_rand * 64,3]</span><br>    inputs_flat = torch.reshape(inputs,[-<span class="hljs-number">1</span>,inputs.shape[-<span class="hljs-number">1</span>]])<br>    <span class="hljs-comment"># x y z 位置编码 [N_rand * 64,63]</span><br>    embedded = embed_fn(inputs_flat)<br><br>    <span class="hljs-keyword">if</span> viewdirs <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        input_dirs = viewdirs[:,<span class="hljs-literal">None</span>].expand(inputs.shape)<br>        input_dirs_flat = torch.reshape(input_dirs,[-<span class="hljs-number">1</span>,input_dirs.shape[-<span class="hljs-number">1</span>]])<br>        <span class="hljs-comment"># Theta phi 位置编码</span><br>        <span class="hljs-comment"># [N_rand * 64 , 27]</span><br>        embedded_dirs = embeddirs_fn(input_dirs_flat)<br>        <span class="hljs-comment"># 把所有编码完成的拼接起来 [N_rand * 64,63 + 27]</span><br>        embedded = torch.cat([embedded,embedded_dirs],-<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># chunk=netchunk = 1024 * 64</span><br>    <span class="hljs-comment"># outputs_flat = torch.cat([fn(embedded[i,i+chunk]) for i in range(0,embedded.shape[0],chunk)],0)</span><br>    outputs_flat = batchify(fn,netchunk)(embedded)<br><br>    outputs = torch.reshape(outputs_flat,<span class="hljs-built_in">list</span>(inputs.shape[:-<span class="hljs-number">1</span>])+[outputs_flat.shape[-<span class="hljs-number">1</span>]])<br>    <span class="hljs-keyword">return</span> outputs<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_nerf</span>(<span class="hljs-params">args</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    这里，input_embedding是通过常规embedding层，将每一个token的向量维度从vocab_size映射到d_model.</span><br><span class="hljs-string">    由于是相加关系，自然而然地，这里的positional_encoding也是一个d_model维度的向量。（在原论文里，d_model = 512）</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    Input embedding 是一种常用的将离散的输入转换成连续向量的方式。 ！！！长度不一样的转换为长度一样的！！！</span><br><span class="hljs-string">    例如，在自然语言处理任务中，输入可以是一个单词或一个字符，而输入嵌入可以将其转换成一个固定长度的向量，以便更好地在神经网络中处理。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    而位置编码则是一种将位置信息嵌入到输入中的方式。在一些场景中，输入的位置信息往往与输出结果密切相关。 ！！！长度一样的编码编程独特的位置码方便识别！！！</span><br><span class="hljs-string">    例如，在机器翻译任务中，输入句子中单词的位置和输出句子中单词的位置往往是对应的。为了更好地利用位置信息，可以使用位置编码来为每个输入位置分配一个特定的编码向量。</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    在 NeRF 中，位置编码的作用是为每个采样点的位置分配一个编码向量，以便更好地利用位置信息。</span><br><span class="hljs-string">    而输入嵌入则用于将其他信息，如视角信息，编码成向量。这两种编码方式的作用不同，但都可以帮助模型更好地利用输入信息。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    multires = args.multires<br>    multires_views = args.multires_views<br>    i_embed = args.i_embed<br>    use_viewdirs = args.use_viewdirs<br>    N_fine_samples = args.N_fine_samples<br>    netdepth_fine = args.netdepth_fine<br>    netwidth_fine = args.netwidth_fine<br>    netchunk = args.netchunk<br>    lr = args.lrate<br>    basedir = args.basedir<br>    expname = args.expname<br><br><br>    <span class="hljs-comment"># 创建高频、低频 Sin() cos()编码</span><br><br>    <span class="hljs-comment">#Input: layer = 0,Position Encoding 后的长度为 63 的vector</span><br>    embed_fn,input_channel = get_embedder(multires,i_embed)<br><br><br>    input_views_channel = <span class="hljs-number">0</span><br>    embeddirs_fn = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">if</span> use_viewdirs:<br>        <span class="hljs-comment">#use full 5D input instead of 3D  对 x,y,z ,theta , phi 都输入，都编码</span><br>        embeddirs_fn,input_views_channel = get_embedder(multires_views,i_embed)<br><br>    <span class="hljs-comment"># 当精细网络每条光线上的采样点数量不为0的时候，输出channel数量为5</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    当不采用精细采样时，只需要预测四个通道：三个用于表示 RGB 颜色值，一个用于表示透明度。</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    output_channel = <span class="hljs-number">5</span> <span class="hljs-keyword">if</span> N_fine_samples&gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">4</span><br>    skips = [<span class="hljs-number">4</span>]<br><br>    <span class="hljs-comment"># model = NeRF()</span><br>    model = NeRF(D=args.netdepth, W=args.netwidth,<br>                 input_channel=input_channel, output_channel=output_channel, skips=skips,<br>                 input_views_channel=input_views_channel, use_viewdirs=use_viewdirs)<br>    <span class="hljs-comment"># 存储粗网络中的参数</span><br>    grad_vars = <span class="hljs-built_in">list</span>(model.parameters())<br><br><br>    model_fine = <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 精细网络</span><br>    <span class="hljs-keyword">if</span> N_fine_samples&gt;<span class="hljs-number">0</span>:<br>        model_fine =NeRF(D=netdepth_fine,W=netwidth_fine,<br>                         input_channel=input_channel,output_channel=output_channel,skips=skips,<br>                         input_views_channel=input_views_channel,use_viewdirs=use_viewdirs)<br>        <span class="hljs-comment"># 存储精细网络中的参数</span><br>        grad_vars+=<span class="hljs-built_in">list</span>(model_fine.parameters())<br><br><br>    <span class="hljs-comment"># todo runnetwork 是不是真正跑神经网络的地方？</span><br>    network_query_fn = <span class="hljs-keyword">lambda</span> inputs,viewdirs,network_fn:run_network(inputs,viewdirs,network_fn,<br>                                                                     embed_fn=embed_fn,<br>                                                                     embeddirs_fn=embeddirs_fn,<br>                                                                     netchunk=netchunk)<br>    <span class="hljs-comment"># 创建优化器</span><br>    optimizer =torch.optim.Adam(params=grad_vars,lr=lr,betas=(<span class="hljs-number">0.9</span>,<span class="hljs-number">0.999</span>))<br><br>    start = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment">##########################</span><br><br>    <span class="hljs-comment"># Load checkpoints</span><br>    <span class="hljs-keyword">if</span> args.ft_path <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> args.ft_path != <span class="hljs-string">&#x27;None&#x27;</span>:<br>        ckpts = [args.ft_path]<br>    <span class="hljs-keyword">else</span>:<br>        ckpts = [os.path.join(basedir, expname, f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(os.listdir(os.path.join(basedir, expname))) <span class="hljs-keyword">if</span><br>                 <span class="hljs-string">&#x27;tar&#x27;</span> <span class="hljs-keyword">in</span> f]<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Found ckpts&#x27;</span>, ckpts)<br><br>    <span class="hljs-comment"># load参数 如果检测到跑到一半的结果或者模型</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ckpts) &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> args.no_reload:<br>        ckpt_path = ckpts[-<span class="hljs-number">1</span>]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Reloading from&#x27;</span>, ckpt_path)<br>        ckpt = torch.load(ckpt_path)<br><br>        start = ckpt[<span class="hljs-string">&#x27;global_step&#x27;</span>]<br>        optimizer.load_state_dict(ckpt[<span class="hljs-string">&#x27;optimizer_state_dict&#x27;</span>])<br><br>        <span class="hljs-comment"># Load model</span><br>        model.load_state_dict(ckpt[<span class="hljs-string">&#x27;network_fn_state_dict&#x27;</span>])<br>        <span class="hljs-keyword">if</span> model_fine <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            model_fine.load_state_dict(ckpt[<span class="hljs-string">&#x27;network_fine_state_dict&#x27;</span>])<br><br>    <span class="hljs-comment">##########################</span><br><br>    <span class="hljs-comment"># 存放训练神经网络、渲染结果的函数和参数的元组</span><br>    render_kwargs_train = &#123;<br>        <span class="hljs-string">&#x27;network_query_fn&#x27;</span>: network_query_fn,<br>        <span class="hljs-string">&#x27;perturb&#x27;</span>: args.perturb,<br>        <span class="hljs-string">&#x27;N_fine_samples&#x27;</span>: args.N_fine_samples,<br>        <span class="hljs-comment"># 精细网络</span><br>        <span class="hljs-string">&#x27;network_fine&#x27;</span>: model_fine,<br>        <span class="hljs-string">&#x27;N_coarse_samples&#x27;</span>: args.N_coarse_samples,<br>        <span class="hljs-comment"># 粗网络</span><br>        <span class="hljs-string">&#x27;network_fn&#x27;</span>: model,<br>        <span class="hljs-string">&#x27;use_viewdirs&#x27;</span>: args.use_viewdirs,<br>        <span class="hljs-string">&#x27;white_bkgd&#x27;</span>: args.white_bkgd,<br>        <span class="hljs-string">&#x27;raw_noise_std&#x27;</span>: args.raw_noise_std,<br>    &#125;<br><br>    <span class="hljs-built_in">print</span>(model_fine)<br><br>    <span class="hljs-comment"># NDC only good for LLFF-style forward facing data</span><br>    <span class="hljs-comment"># 非LLFF数据，ndc设为False</span><br>    <span class="hljs-keyword">if</span> args.dataset_type != <span class="hljs-string">&#x27;llff&#x27;</span> <span class="hljs-keyword">or</span> args.no_ndc:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Not ndc!&#x27;</span>)<br>        render_kwargs_train[<span class="hljs-string">&#x27;ndc&#x27;</span>] = <span class="hljs-literal">False</span><br>        render_kwargs_train[<span class="hljs-string">&#x27;lindisp&#x27;</span>] = args.lindisp<br><br>    render_kwargs_test = &#123;k: render_kwargs_train[k] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> render_kwargs_train&#125;<br>    render_kwargs_test[<span class="hljs-string">&#x27;perturb&#x27;</span>] = <span class="hljs-literal">False</span><br>    render_kwargs_test[<span class="hljs-string">&#x27;raw_noise_std&#x27;</span>] = <span class="hljs-number">0.</span><br><br>    <span class="hljs-keyword">return</span> render_kwargs_train, render_kwargs_test, start, grad_vars, optimizer<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_log_files</span>(<span class="hljs-params">basedir,expname,args</span>):<br>    os.makedirs(os.path.join(basedir,expname),exist_ok=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 保存参数文件</span><br>    f = os.path.join(basedir,expname,<span class="hljs-string">&#x27;args.txt&#x27;</span>)<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(f,<span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>        <span class="hljs-keyword">for</span> arg <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(<span class="hljs-built_in">vars</span>(args)):<br>            attr = <span class="hljs-built_in">getattr</span>(args,arg)<br>            file.write(<span class="hljs-string">&#x27;&#123;&#125;=&#123;&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(arg,attr))<br><br>    <span class="hljs-keyword">if</span> args.config <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        f = os.path.join(basedir,expname,<span class="hljs-string">&#x27;config.txt&#x27;</span>)<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(f,<span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>            file.write(<span class="hljs-built_in">open</span>(args.config,<span class="hljs-string">&#x27;r&#x27;</span>).read())<br><br>    <span class="hljs-keyword">return</span> basedir,expname<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>():<br>    parser = config_parser()<br>    args = parser.parse_args()<br><br>    <span class="hljs-comment"># 数据文件夹</span><br>    datadir = args.datadir<br>    <span class="hljs-comment"># 根目录文件夹</span><br>    basedir = args.basedir<br>    <span class="hljs-comment"># 本次测试的名称</span><br>    expname = args.expname<br>    <span class="hljs-comment"># 数据类型</span><br>    datatype  = args.dataset_type<br>    <span class="hljs-comment"># 缩放因子</span><br>    factor = args.factor<br>    <span class="hljs-comment"># 360°视频 球形化相机位置</span><br>    spherify = args.spherify<br>    <span class="hljs-comment"># llff 测试集抽取间隔</span><br>    llffhold = args.llffhold<br>    <span class="hljs-comment"># bool值 表示是否定义了边界</span><br>    no_ndc = args.no_ndc<br>    <span class="hljs-comment"># bool值 表示当前是否是渲染测试集</span><br>    render_test = args.render_test<br>    <span class="hljs-comment">#设定相机的内参矩阵为None</span><br>    K = <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 如果是LLFF数据集</span><br>    <span class="hljs-keyword">if</span> datatype== <span class="hljs-string">&quot;llff&quot;</span>:<br>        <span class="hljs-comment"># images 20 x 378 x 504 x 3  N H W RGB</span><br>        <span class="hljs-comment"># poses 20 x 3 x 5 N R T HWF</span><br>        <span class="hljs-comment"># bds 20 x 2 N near far</span><br>        <span class="hljs-comment"># render_poses 120 x 3 x 5  render_pose R T HWF</span><br>        <span class="hljs-comment"># i_test 12 20张里面抽样12张</span><br>        images,\<br>        poses,\<br>        bds,\<br>        render_poses,\<br>        i_test = load_llff_data(datadir,<br>                                factor,<br>                                recenter=<span class="hljs-literal">True</span>,<br>                                bd_factor = <span class="hljs-number">0.75</span>,<br>                                spherify = spherify)<br>    <span class="hljs-comment"># images</span><br>        <span class="hljs-comment"># 获取照片的高度、宽度、焦距</span><br>        hwf = poses[<span class="hljs-number">0</span>,:<span class="hljs-number">3</span>,-<span class="hljs-number">1</span>]<br>        <span class="hljs-comment"># 获取所有照片的位姿信息 c2w 20 x 3 x 4</span><br>        poses = poses[:,:<span class="hljs-number">3</span>,:<span class="hljs-number">4</span>]<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;load llff&quot;</span>,images.shape,render_poses.shape,hwf,datadir)<br>        <span class="hljs-comment"># # i_test 测试所用的照片的下标 转为字典 方便后面存储抽样的下标</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(i_test,<span class="hljs-built_in">list</span>):<br>            i_test=[i_test]<br>        <span class="hljs-comment"># 按llffhold的采样间隔抽取照片 [0.。。20] -&gt; [0 8 16]</span><br>        <span class="hljs-keyword">if</span>  llffhold&gt;<span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Auto LLFF holdout&quot;</span>,llffhold)<br>            i_test = np.arange(images.shape[<span class="hljs-number">0</span>])[::llffhold]<br>        <span class="hljs-comment"># 设置测试集标签</span><br>        i_val = i_test<br>        <span class="hljs-comment"># 剩下的作为训练集标签</span><br>        i_train = np.array([i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> np.arange(<span class="hljs-built_in">int</span>(images.shape[<span class="hljs-number">0</span>])) <span class="hljs-keyword">if</span><br>                            (i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> i_test <span class="hljs-keyword">and</span> i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> i_val )])<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;DEFINING BOUNDS&quot;</span>)<br>        <span class="hljs-comment"># 定义照片的near和far 分别代表光线采样区间内最近的点和最远的点</span><br>        <span class="hljs-keyword">if</span> no_ndc:<br>            near = np.ndarray.<span class="hljs-built_in">min</span>(bds)*<span class="hljs-number">0.9</span><br>            far = np.ndarray.<span class="hljs-built_in">max</span>(bds)*<span class="hljs-number">1.0</span><br>        <span class="hljs-keyword">else</span>:<br>            near = <span class="hljs-number">0.0</span><br>            far = <span class="hljs-number">1.0</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Near:&quot;</span>,near,<span class="hljs-string">&quot;Far&quot;</span>,far)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Unknown dataset type&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-comment"># H W 转为Int类型</span><br>    H,W,focal = hwf<br>    H,W = <span class="hljs-built_in">int</span>(H),<span class="hljs-built_in">int</span>(W)<br>    hwf = [H,W,focal]<br><br>    <span class="hljs-comment">#定义相机的内参矩阵</span><br>    <span class="hljs-keyword">if</span> K <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        K = np.array([<br>            [focal,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>*W],<br>            [<span class="hljs-number">0</span>,focal,<span class="hljs-number">0.5</span>*H],<br>            [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>]<br>        ])<br><br>    <span class="hljs-comment">###</span><br>    <span class="hljs-comment">#这一部分定义相机最后的渲染 渲染测试集</span><br>    <span class="hljs-keyword">if</span> render_test:<br>        render_poses = np.array(poses[i_test])<br><br>    <span class="hljs-comment"># 不是渲染测试集的话，把最后渲染视频的相机位姿送到GPU</span><br>    render_poses = torch.Tensor(render_poses).to(device)<br><br>    <span class="hljs-comment">###</span><br>    <span class="hljs-comment"># 这一部分创建最后的输出文件和保存此次训练所用的参数</span><br>    create_log_files(basedir,expname,args)<br><br>    <span class="hljs-comment"># ---------------------------------------------------------------------------------------------------</span><br><br>    <span class="hljs-comment"># 构建NeRF模型</span><br>    <span class="hljs-comment"># 网络参数 开始计数 梯度参数 优化器</span><br>    render_kwargs_train,render_kwargs_test,start,grad_vars,optimizer = create_nerf(args)<br><br>    <span class="hljs-comment">#</span><br>    global_setp = start<br><br>    <span class="hljs-comment"># 设置采样的边界 near far</span><br>    bds_dict=&#123;<br>        <span class="hljs-string">&#x27;near&#x27;</span>:near,<br>        <span class="hljs-string">&#x27;far&#x27;</span>:far,<br>    &#125;<br>    <span class="hljs-comment"># 更新 near far参数</span><br>    render_kwargs_train.update(bds_dict)<br>    render_kwargs_test.update(bds_dict)<br><br>    <span class="hljs-comment"># —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— —— ——</span><br>    <span class="hljs-comment"># 仅仅渲染之前的训练好的模型</span><br>    <span class="hljs-keyword">if</span> args.render_only:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Render Only&quot;</span>)<br>        <span class="hljs-comment"># 仅仅进行渲染，不进行训练</span><br>        run_render_only(args,images,i_test,basedir,expname,render_poses,hwf,K,render_kwargs_test,start)<br>        <span class="hljs-keyword">return</span><br><br><br>    N_rand= args.N_rand<br>    use_batching = <span class="hljs-keyword">not</span> args.no_batching<br><br>    <span class="hljs-keyword">if</span> use_batching:<br>        <span class="hljs-comment">#打乱光线</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;getting rays&quot;</span>)<br>        <span class="hljs-comment"># 每张照片的位姿是p 每张照片由H*w个像素 每个像素生成一个光线(ro+rd)</span><br>        <span class="hljs-comment"># [N,ro+rd,H,W,3]</span><br>        rays = np.stack([get_rays_np(H,W,K,p) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> poses[:,:<span class="hljs-number">3</span>,:<span class="hljs-number">4</span>]],<span class="hljs-number">0</span>)<br>        <span class="hljs-comment"># 将光线与实际照片对应的像素结合在一起</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;concats&#x27;</span>)<br>        <span class="hljs-comment"># 在第二个维度拼接</span><br>        <span class="hljs-comment"># images[:,None] images:[217,1,120,160,3]</span><br>        <span class="hljs-comment"># [N, ro + rd + imgRGB, H, W, 3]</span><br>        rays_rgb = np.concatenate([rays,images[:,<span class="hljs-literal">None</span>]],<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># 变换坐标轴顺序 [N,H,W,ro+rd+imgRGB,3]</span><br>        rays_rgb = np.transpose(rays_rgb,[<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">4</span>])<br>        <span class="hljs-comment"># 使用训练集数据</span><br>        rays_rgb = np.stack([rays_rgb[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> i_train],<span class="hljs-number">0</span>)<br>        <span class="hljs-comment"># reshape数据 [(N-1) x H x W ,3,3]</span><br>        rays_rgb = np.reshape(rays_rgb,[-<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>])<br>        rays_rgb = rays_rgb.astype(np.float32)<br>        <span class="hljs-comment"># todo 打乱光线数据  比较费时</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;shuffle rays&quot;</span>)<br>        np.random.shuffle(rays_rgb)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;shuffle rays done&quot;</span>)<br><br>        i_batch = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># 放入Cuda</span><br>    <span class="hljs-keyword">if</span> use_batching:<br>        images = torch.Tensor(images).to(device)<br>        rays_rgb = torch.Tensor(rays_rgb).to(device)<br><br>    poses = torch.Tensor(poses).to(device)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Begin&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trains views are&#x27;</span>,i_train)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Test views are&#x27;</span>, i_test)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Val views are&#x27;</span>, i_val)<br><br>    <span class="hljs-comment">## 开始训练</span><br>    <span class="hljs-comment">## 20W次迭代</span><br><br><br>    N_iters = <span class="hljs-number">200000</span>+<span class="hljs-number">1</span><br>    start = start+<span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> trange(start,N_iters):<br>        time0 = time.time()<br>        <span class="hljs-comment"># 是否将随机的光线分批放入神经网络,分批的大小为N_rand(1024)</span><br>        <span class="hljs-comment"># 如果是的话，每个iter 选 N_rand个光线送去算</span><br>        <span class="hljs-comment"># 所有的都选过一遍之后再i_batch置0</span><br>        <span class="hljs-keyword">if</span> use_batching:<br>            <span class="hljs-comment"># [x:x+1024, ro+rd+rgb, 3]</span><br>            <span class="hljs-comment"># [1024,3,3]</span><br>            batch = rays_rgb[i_batch:i_batch+N_rand]<br>            <span class="hljs-comment"># [ro+rd+rgb,1024,3]</span><br>            <span class="hljs-comment"># [3,1024,3]</span><br>            batch = torch.transpose(batch,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)<br>            <span class="hljs-comment"># batch_rays: ro+rd [2,1024,3]</span><br>            <span class="hljs-comment"># target_rgb: imgRGB [1,1024,3]</span><br>            batch_rays,traget_rgb = batch[:<span class="hljs-number">2</span>],batch[<span class="hljs-number">2</span>]<br><br>            i_batch+=N_rand<br>            <span class="hljs-comment"># 判断是否都选过</span><br>            <span class="hljs-keyword">if</span> i_batch&gt;=rays_rgb.shape[<span class="hljs-number">0</span>]:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Shuffle data after an epoch&quot;</span>)<br>                rand_idx = torch.randperm(rays_rgb.shape[<span class="hljs-number">0</span>])<br>                rays_rgb = rays_rgb[rand_idx]<br>                i_batch = <span class="hljs-number">0</span><br><br>        <span class="hljs-comment"># todo 用一张图片计算？暂时先不写了</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">pass</span><br>            <span class="hljs-comment"># 选一个训练的下标作为训练图片的下标</span><br>            <span class="hljs-comment"># img_idx = np.random.choice(i_train)</span><br>            <span class="hljs-comment"># target_img = images[img_idx]</span><br><br>        <span class="hljs-comment"># 核心优化的循环</span><br>        <span class="hljs-comment"># 输出精细神经网络内容</span><br>        <span class="hljs-comment"># etxras里存储粗网络的内容</span><br>        <span class="hljs-comment"># 返回的list 前三个是 [&#x27;rgb_fine_map&#x27;,&#x27;disp_fine_map&#x27;,&#x27;acc_fine_map&#x27;]</span><br>        <span class="hljs-comment"># 后四个是 [rgb_corse_map disp_corse_map acc_corse_map z_std]</span><br><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            源代码写的太乱了</span><br><span class="hljs-string">            render(render_kwargs_train存放要调用的神经网络)--&gt;</span><br><span class="hljs-string">            batchify_rays--&gt;</span><br><span class="hljs-string">            render_rays(在里面经过神经网络)--&gt;</span><br><span class="hljs-string">            network_query_fn(调用神经网络)--&gt;</span><br><span class="hljs-string">            run_network(真正跑神经网络的地方)--&gt;</span><br><span class="hljs-string">            batchify(network_fn,netchunk)(embedded)--&gt;</span><br><span class="hljs-string">            # render_kwargs_train里存放的 network_fn:model</span><br><span class="hljs-string">            torch.cat([network_fn(inputs[i,i+chunk]) for i in range(0,inputs.shape[0],chunk)],0)</span><br><span class="hljs-string">            </span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        rgb_fine_map, disp_fine_map, acc_fine_map, extras = render(H,W,K,<br>                                        chunk=args.chunk,<br>                                        rays=batch_rays,<br>                                        verbose=i&lt;<span class="hljs-number">10</span>,<br>                                        retraw=<span class="hljs-literal">True</span>,<br>                                        **render_kwargs_train)<br><br>        <span class="hljs-comment"># 初始化优化器</span><br>        optimizer.zero_grad()<br>        <span class="hljs-comment">#计算loss MSE 误差</span><br>        img_loss = img2mse(rgb_fine_map,traget_rgb)<br>        <span class="hljs-comment"># 计算PSNR</span><br>        loss = img_loss<br>        psnr_fine = mse2psnr(img_loss)<br><br>        <span class="hljs-comment"># 这个dist在 render&lt;--all_ret&lt;--render_rays里生成</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;rgb_coarse_map&#x27;</span> <span class="hljs-keyword">in</span> extras:<br>            <span class="hljs-comment"># 如果用了粗网络，把粗网络的</span><br>            img_loss_coarse = img2mse(extras[<span class="hljs-string">&#x27;rgb_coarse_map&#x27;</span>],traget_rgb)<br>            loss = loss + img_loss_coarse<br>            psnr_coarse = mse2psnr(img_loss_coarse)<br><br>        <span class="hljs-comment"># 误差的反向传播</span><br>        loss.backward()<br>        optimizer.step()<br><br>        <span class="hljs-comment"># 学习率衰减</span><br>        decay_rate =<span class="hljs-number">0.1</span><br>        decay_steps = args.lrate_decay*<span class="hljs-number">1000</span><br>        <span class="hljs-comment"># 按步长衰减</span><br>        new_lrate= args.lrate * (decay_rate**(global_setp/decay_steps))<br>        <span class="hljs-comment"># 更新学习率</span><br>        <span class="hljs-keyword">for</span> param_group <span class="hljs-keyword">in</span> optimizer.param_groups:<br>            param_group[<span class="hljs-string">&#x27;lr&#x27;</span>] = new_lrate<br><br>        <span class="hljs-comment"># 保存模型</span><br>        <span class="hljs-comment"># i_weights 10000 每隔1w次保存一次</span><br>        <span class="hljs-keyword">if</span> i % args.i_weights ==<span class="hljs-number">0</span>:<br>            path = os.path.join(basedir,expname,<span class="hljs-string">&#x27;&#123;:06d&#125;.tar&#x27;</span>.<span class="hljs-built_in">format</span>(i))<br>            torch.save(&#123;<br>                <span class="hljs-comment"># 运行的轮数</span><br>                <span class="hljs-string">&quot;global_step&quot;</span>:global_setp,<br>                <span class="hljs-string">&quot;network_fn_state_dict&quot;</span>:render_kwargs_train[<span class="hljs-string">&#x27;network_fn&#x27;</span>].state_dict(),<br>                <span class="hljs-string">&quot;network_fine_state_dict&quot;</span>:render_kwargs_train[<span class="hljs-string">&#x27;network_fine&#x27;</span>].state_dict(),<br>                <span class="hljs-string">&quot;optimizer_state_dict&quot;</span>:optimizer.state_dict()<br>            &#125;,path)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Saving checkpoints at &quot;</span>,path,<span class="hljs-string">&quot;Num. &quot;</span>,i)<br><br>        <span class="hljs-comment"># 生成测试视频</span><br>        <span class="hljs-keyword">if</span> i % args.i_video ==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> i&gt;<span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># 用测试数据生成视频 不是训练数据的视频</span><br>            <span class="hljs-comment"># 下面的不记录梯度</span><br>            <span class="hljs-keyword">with</span> torch.no_grad():<br>                rgbs,disps = render_path(render_poses,hwf,K,args.chunk,render_kwargs_test)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done, Saving&quot;</span>,rgbs.shape,disps.shape)<br>            <span class="hljs-comment"># 视频渲染的路径</span><br>            moviebase = os.path.join(basedir,expname,<span class="hljs-string">&#x27;&#123;&#125;_sprial&#123;:06d&#125;_&#x27;</span>.<span class="hljs-built_in">format</span>(expname,i))<br>            <span class="hljs-comment"># 360度环绕一圈的视频</span><br>            imageio.mimwrite(moviebase+<span class="hljs-string">&#x27;rgb.mp4&#x27;</span>,to8b(rgbs),fps=<span class="hljs-number">30</span>,quality=<span class="hljs-number">8</span>)<br>            <span class="hljs-comment"># 深度视频</span><br>            imageio.mimwrite(moviebase+<span class="hljs-string">&#x27;disp.mp4&#x27;</span>,to8b(disps/np.<span class="hljs-built_in">max</span>(disps)),fps=<span class="hljs-number">30</span>,quality=<span class="hljs-number">8</span>)<br><br>        <span class="hljs-comment"># 执行测试，使用测试数据</span><br>        <span class="hljs-keyword">if</span> i % args.i_testset ==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> i &gt; <span class="hljs-number">0</span>:<br>            testsavedir = os.path.join(basedir,expname,<span class="hljs-string">&quot;testset_&#123;:06d&#125;&quot;</span>.<span class="hljs-built_in">format</span>(i))<br>            os.makedirs(testsavedir,exist_ok=<span class="hljs-literal">True</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;test poses shape&quot;</span>,poses[i_test].shape)<br>            <span class="hljs-keyword">with</span> torch.no_grad():<br>                render_path(torch.Tensor(poses[i_test]).to(device),hwf,K,args.chunk,render_kwargs_test,<br>                            gt_images=images[i_test],savedir=testsavedir)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Save test set&quot;</span>)<br><br>        <span class="hljs-comment"># 计算用时</span><br>        dt = time.time() - time0<br><br>        <span class="hljs-comment"># 打印log信息</span><br>        <span class="hljs-keyword">if</span> i % args.i_print == <span class="hljs-number">0</span>:<br>            tqdm.write(<span class="hljs-string">f&quot;[Train] Iter:<span class="hljs-subst">&#123;i&#125;</span> Loss: <span class="hljs-subst">&#123;loss.item()&#125;</span> PSNR:<span class="hljs-subst">&#123;psnr_fine.item()&#125;</span> Time: <span class="hljs-subst">&#123;dt&#125;</span>&quot;</span>)<br><br>        global_setp += <span class="hljs-number">1</span><br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> torch.cuda.is_available():<br>        torch.set_default_tensor_type(<span class="hljs-string">&quot;torch.cuda.FloatTensor&quot;</span>)<br>    train()<br><br></code></pre></td></tr></table></figure>



<h4 id="render-py"><a href="#render-py" class="headerlink" title="render.py"></a>render.py</h4><p><em>render_path：</em> 调用<em>render</em>函数，将结果保存为图像(一般只进行渲染的时候会用到)</p>
<p><em>render：</em> 渲染前的准备工作以及渲染，调用<em>batchify_rays</em></p>
<p><em>batchify_rays：</em>光线分批次chunk,调用<em>render_rays</em>,返回全部神经网络计算完经过raw2outputs的结果(<code>all_ret</code>)</p>
<p><em>render_rays：</em>按批次大小chunk渲染光线，通过调用<em>network_query_fn</em>使用神经网络，得到神经网络的输出，再调用<em>raw2outputs返回一个chunk神经网络计算完经过raw2outputs的结果</em></p>
<p><em>raw2outputs：</em>神经网络的原始数据数据转化为具体的rgb、depth等输出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> imageio<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">from</span> rays <span class="hljs-keyword">import</span> get_rays,ndc_rays<br><span class="hljs-keyword">from</span> sample_pdf <span class="hljs-keyword">import</span> sample_pdf<br><br>DEBUG = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">to8b</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">return</span> (<span class="hljs-number">255</span>*np.clip(x,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)).astype(np.uint8)<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">raw2outputs</span>(<span class="hljs-params">raw,z_vals,rays_d,raw_noise_std=<span class="hljs-number">0</span>,white_bkgd=<span class="hljs-literal">False</span>,pytest=<span class="hljs-literal">False</span></span>):<br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    由原始数据计算 rgb_map, disp_map, acc_map, weights, depth_map</span><br><span class="hljs-string">    :param raw: 神经网络的输出值  batch_size x 4 [R G B , alpha]</span><br><span class="hljs-string">    :param z_vals: 采样点</span><br><span class="hljs-string">    :param rays_d: 光线的方向</span><br><span class="hljs-string">    :param raw_noise_std: 噪声</span><br><span class="hljs-string">    :param white_bkgd: bool 是否随机背景</span><br><span class="hljs-string">    :param pytest: todo 不知道</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 等同于def raw2rgb(raw,dist,act_fn=F.relu):&#123;</span><br>    <span class="hljs-comment">#   return 1-torch.exp(-F.relu(raw)*dist)</span><br>    <span class="hljs-comment"># &#125;</span><br><br>    <span class="hljs-comment"># 返回表示alpha的张量 act_fn 默认情况下为F.relu()函数</span><br>    <span class="hljs-comment"># 看公式3</span><br><br>    raw2alpha = <span class="hljs-keyword">lambda</span> raw, dists, act_fn=F.relu: <span class="hljs-number">1.</span> - torch.exp(-act_fn(raw) * dists)<br><br>    <span class="hljs-comment"># 计算光线上两点之间的距离 错项做差  1024 x 63</span><br>    dists = z_vals[...,<span class="hljs-number">1</span>:]-z_vals[...,:-<span class="hljs-number">1</span>]<br>    <span class="hljs-comment">#  1024 x 63 --&gt; 1024 x 64 把 1024 x 1 的 1e10张量拼接到 dists张量最后</span><br>    <span class="hljs-comment">#  表示最后一个点到第一个点的距离为无穷远</span><br>    dists = torch.cat([dists, torch.Tensor([<span class="hljs-number">1e10</span>]).expand(dists[..., :<span class="hljs-number">1</span>].shape)], -<span class="hljs-number">1</span>)<br>    <span class="hljs-comment">#  计算相邻两点间的距离 todo 再乘以dist纠正？</span><br>    dists = dists * torch.norm(rays_d[...,<span class="hljs-literal">None</span>,:],dim=-<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># raw 前三列代表rgb值 用sigmod函数将rgb值映射到0~1之间</span><br>    rgb = torch.sigmoid(raw[...,:<span class="hljs-number">3</span>])<br><br>    <span class="hljs-comment"># 制造噪声</span><br>    noise = <span class="hljs-number">0.0</span><br>    <span class="hljs-keyword">if</span> raw_noise_std&gt;<span class="hljs-number">0</span>:<br>        noise = torch.randn(raw[...,<span class="hljs-number">3</span>].shape)*raw_noise_std<br>        <span class="hljs-keyword">if</span> pytest:<br>            np.random.seed(<span class="hljs-number">0</span>)<br>            <span class="hljs-comment"># todo 不知道什么意思</span><br>            noise = np.random.rand(*<span class="hljs-built_in">list</span>(raw[...,<span class="hljs-number">3</span>].shape))*raw_noise_std<br>            noise = torch.Tensor(noise)<br><br>    <span class="hljs-comment"># 计算透明度</span><br>    alpha = raw2alpha(raw[...,<span class="hljs-number">3</span>]+noise,dists)<br><br>    <span class="hljs-comment"># 计算权重T 累积透过率 表面透明度的衰减</span><br>    <span class="hljs-comment"># torch.cumprod 返回尺寸为 dim 的 input 元素的累积积。</span><br>    <span class="hljs-comment"># ones 作为第一列 cat (ones,alpha) --&gt; 1024 x 65  cumpord --&gt; 1024 x 65 --&gt;[:,:-1]  1024 x 64</span><br>    weights = alpha * torch.cumprod(torch.cat([torch.ones((alpha.shape[<span class="hljs-number">0</span>],<span class="hljs-number">1</span>)),<span class="hljs-number">1.0</span>-alpha+<span class="hljs-number">1e-10</span>],-<span class="hljs-number">1</span>),-<span class="hljs-number">1</span>)[:,:-<span class="hljs-number">1</span>]<br><br>    <span class="hljs-comment"># 计算公式3  C(r) 预期颜色</span><br>    rgb_map = torch.<span class="hljs-built_in">sum</span>(weights[...,<span class="hljs-literal">None</span>]*rgb,-<span class="hljs-number">2</span>)<br><br>    <span class="hljs-comment"># 计算深度图</span><br>    depth_map = torch.<span class="hljs-built_in">sum</span>(weights*z_vals,-<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 视差图</span><br>    <span class="hljs-comment"># Disparity map is inverse depth.</span><br>    disp_map = <span class="hljs-number">1.</span> / torch.<span class="hljs-built_in">max</span>(<span class="hljs-number">1e-10</span> * torch.ones_like(depth_map), depth_map / torch.<span class="hljs-built_in">sum</span>(weights, -<span class="hljs-number">1</span>))<br><br><br>    <span class="hljs-comment"># 权重和</span><br>    <span class="hljs-comment"># 这个值仅做了输出用，后续并无使用</span><br>    acc_map = torch.<span class="hljs-built_in">sum</span>(weights, -<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">if</span> white_bkgd:<br>        rgb_map = rgb_map + (<span class="hljs-number">1.</span> - acc_map[..., <span class="hljs-literal">None</span>])<br><br>    <span class="hljs-keyword">return</span> rgb_map, disp_map, acc_map, weights, depth_map<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">batchify_rays</span>(<span class="hljs-params">rays_flat,chunk=<span class="hljs-number">1024</span>*<span class="hljs-number">32</span>,**kwargs</span>):<br><br>    all_ret=&#123;&#125;<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,rays_flat.shape[<span class="hljs-number">0</span>],chunk):<br>        <span class="hljs-comment"># ret 一个chunksize量的光线</span><br>        <span class="hljs-comment"># rgb_fine_map, disp_fine_map, acc_fine_map, rgb_coarse_map, disp_coarse_map, acc_coarse_map, z_std</span><br>        <span class="hljs-comment"># chunk x 3 chunk x 1 chunk x 1 chunk x 3 chunk x 3 chunk x 1 chunk x 1</span><br>        ret = render_rays(rays_flat[i:i+chunk,:],**kwargs)<br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> ret:<br>            <span class="hljs-keyword">if</span> k <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> all_ret:<br>                all_ret[k] = []<br>            all_ret[k].append(ret[k])<br>    all_ret = &#123;k:torch.cat(all_ret[k],<span class="hljs-number">0</span>)<span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> all_ret&#125;<br>    <span class="hljs-comment"># 所有的rays_flat的量 / chunsize 组 ret 拼接到一起</span><br>    <span class="hljs-comment"># 在all_ret中用 i 提取 第 i 组 大小为 chunsize 的ret</span><br>    <span class="hljs-keyword">return</span> all_ret<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">render_rays</span>(<span class="hljs-params">ray_batch,</span><br><span class="hljs-params">                network_fn,</span><br><span class="hljs-params">                network_query_fn,</span><br><span class="hljs-params">                N_coarse_samples,</span><br><span class="hljs-params">                retraw=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">                lindisp=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">                perturb=<span class="hljs-number">0</span>,</span><br><span class="hljs-params">                N_fine_samples=<span class="hljs-number">0</span>,</span><br><span class="hljs-params">                network_fine=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">                white_bkgd=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">                raw_noise_std=<span class="hljs-number">0</span>,</span><br><span class="hljs-params">                verbose=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">                pytest=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    输入光线</span><br><span class="hljs-string">    经过神经网络--&gt;raw</span><br><span class="hljs-string">    raw 经过raw2outputs函数 --&gt; rgb_map, disp_map, acc_map, weights, depth_map</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param ray_batch: 光线</span><br><span class="hljs-string">    :param network_fn: 放神经网络的函数</span><br><span class="hljs-string">    :param network_query_fn:</span><br><span class="hljs-string">    :param N_coarse_samples: 粗网格采样点个数64</span><br><span class="hljs-string">    :param retraw:</span><br><span class="hljs-string">    :param lindisp: 间隔</span><br><span class="hljs-string">    :param perturb:</span><br><span class="hljs-string">    :param N_fine_samples: 精细网格采样点个数</span><br><span class="hljs-string">    :param network_fine:  精细神经网络</span><br><span class="hljs-string">    :param white_bkgd: 白色背景</span><br><span class="hljs-string">    :param raw_noise_std:</span><br><span class="hljs-string">    :param verbose:</span><br><span class="hljs-string">    :param pytest:</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># batch_size 1024</span><br>    N_rays = ray_batch.shape[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-comment"># rays_o N_rays * 3</span><br>    <span class="hljs-comment"># rays_d N_rays * 3</span><br>    rays_o, rays_d = ray_batch[:, <span class="hljs-number">0</span>:<span class="hljs-number">3</span>], ray_batch[:, <span class="hljs-number">3</span>:<span class="hljs-number">6</span>]<br><br>    <span class="hljs-comment"># 视角的单位向量</span><br>    <span class="hljs-comment"># 1024 x 3</span><br>    viewsdirs = ray_batch[:, -<span class="hljs-number">3</span>:] <span class="hljs-keyword">if</span> ray_batch.shape[-<span class="hljs-number">1</span>] &gt; <span class="hljs-number">8</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 1024 x 1 x 2  near far</span><br>    bounds = torch.reshape(ray_batch[..., <span class="hljs-number">6</span>:<span class="hljs-number">8</span>], [-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>])<br>    near, far = bounds[..., <span class="hljs-number">0</span>], bounds[..., <span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># 光线中的采样点</span><br>    t_vals = torch.linspace(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, steps=N_coarse_samples)<br><br>    <span class="hljs-comment"># lindisp</span><br>    <span class="hljs-comment"># sampling linearly in disparity rather than depth</span><br>    <span class="hljs-comment"># 以视差而非深度进行线性采样</span><br>    <span class="hljs-comment"># z_vals 是t_vals中插值采样出来的结果 可以看作粗采样，后面的精细采样基于z_vals</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> lindisp:<br>        z_vals = near * (<span class="hljs-number">1.0</span> - t_vals) + far * (t_vals)<br>    <span class="hljs-keyword">else</span>:<br>        z_vals = <span class="hljs-number">1.</span> / (<span class="hljs-number">1.0</span> / near * (<span class="hljs-number">1.0</span> - t_vals) + <span class="hljs-number">1.0</span> / far * (t_vals))<br>    z_vals = z_vals.expand([N_rays, N_coarse_samples])<br><br>    <span class="hljs-comment"># todo 不懂</span><br>    <span class="hljs-keyword">if</span> perturb &gt; <span class="hljs-number">0.</span>:<br>        <span class="hljs-comment"># get intervals between samples，64个采样点的中点</span><br>        mids = <span class="hljs-number">.5</span> * (z_vals[..., <span class="hljs-number">1</span>:] + z_vals[..., :-<span class="hljs-number">1</span>])<br>        upper = torch.cat([mids, z_vals[..., -<span class="hljs-number">1</span>:]], -<span class="hljs-number">1</span>)<br>        lower = torch.cat([z_vals[..., :<span class="hljs-number">1</span>], mids], -<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># stratified samples in those intervals</span><br>        t_rand = torch.rand(z_vals.shape)<br><br>        <span class="hljs-comment"># Pytest, overwrite u with numpy&#x27;s fixed random numbers</span><br>        <span class="hljs-keyword">if</span> pytest:<br>            np.random.seed(<span class="hljs-number">0</span>)<br>            t_rand = np.random.rand(*<span class="hljs-built_in">list</span>(z_vals.shape))<br>            t_rand = torch.Tensor(t_rand)<br>        <span class="hljs-comment"># [bs,64] 加上随机的噪声</span><br><br>        z_vals = lower + (upper - lower) * t_rand<br><br>    <span class="hljs-comment"># 计算光线上的采样点的具体情况 采样点的坐标：出发点+距离*方向</span><br>    <span class="hljs-comment">#  1024 |  1 x 3 * 64 x 1 --&gt; 64 x 3 --&gt; 1024 x 64 x 3</span><br>    pts = rays_o[..., <span class="hljs-literal">None</span>, :] + rays_d[..., <span class="hljs-literal">None</span>, :] * z_vals[...,:,<span class="hljs-literal">None</span>]<br><br>    <span class="hljs-comment"># 1024 x 64 x 3</span><br>    <span class="hljs-comment"># 把pts带入到粗网络中计算</span><br>    raw = network_query_fn(pts, viewsdirs, network_fn)<br><br>    <span class="hljs-comment"># 粗网络计算结果</span><br>    rgb_map, disp_map, acc_map, weights, depth_map = raw2outputs(raw, z_vals, rays_d, raw_noise_std, white_bkgd,<br>                                                                 pytest=pytest)<br>    <span class="hljs-comment">#精细网络</span><br>    <span class="hljs-keyword">if</span> N_fine_samples&gt;<span class="hljs-number">0</span>:<br>        <span class="hljs-comment">#先保存粗网络的计算结果</span><br>        rgb_coarse_map, disp_coarse_map, acc_coarse_map = rgb_map, disp_map, acc_map<br>        <span class="hljs-comment"># 从粗采样的64个点中计算精采样的64个点</span><br>        z_fine_vals_mid = <span class="hljs-number">0.5</span>*(z_vals[...,<span class="hljs-number">1</span>:]+z_vals[...,:-<span class="hljs-number">1</span>])<br>        <span class="hljs-comment"># todo 精采样的点在粗采样的区域 按概率密度精采样 Hierarchical Sampling 别的采样的方法，更高效的采样方法？</span><br>        z_fine_vals = sample_pdf(z_fine_vals_mid,weights[...,<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>],N_fine_samples,det=(perturb==<span class="hljs-number">0.0</span>),pytest=pytest)<br>        <span class="hljs-comment"># z_fine_vals 不计算梯度</span><br>        z_fine_vals = z_fine_vals.detach()<br>        <span class="hljs-comment"># 粗采样点和精细采样点合并 共128个采样点 从大到小排序</span><br>        z_fine_vals,_ = torch.sort(torch.cat([z_vals,z_fine_vals],-<span class="hljs-number">1</span>),-<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># 计算采样点在光纤中具体的值 pts_fine 精采样的采样点的值</span><br>        pts_fine = rays_o[...,<span class="hljs-literal">None</span>,:]+rays_d[...,<span class="hljs-literal">None</span>,:]*z_fine_vals[...,:,<span class="hljs-literal">None</span>]<br>        <span class="hljs-comment"># 精细神经网络</span><br>        run_fine_fn = network_fn <span class="hljs-keyword">if</span> network_fine <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> network_fine<br><br>        <span class="hljs-comment">#代入神经网络中计算</span><br>        raw_fine = network_query_fn(pts_fine,viewsdirs,run_fine_fn)<br>        <span class="hljs-comment"># 计算精细神经网络的 rgb_fine_map, disp_fine_map, acc_fine_map, weights_fine, depth_fine_map</span><br>        rgb_fine_map, disp_fine_map, acc_fine_map, weights_fine, depth_fine_map, = raw2outputs(raw_fine,z_fine_vals,rays_d,raw_noise_std,white_bkgd,pytest=pytest)<br><br>        <span class="hljs-comment">#存储</span><br>        ret = &#123;<span class="hljs-string">&#x27;rgb_fine_map&#x27;</span>:rgb_fine_map,<span class="hljs-string">&#x27;disp_fine_map&#x27;</span>:disp_fine_map,<span class="hljs-string">&#x27;acc_fine_map&#x27;</span>:acc_fine_map&#125;<br><br>        <span class="hljs-keyword">if</span> retraw:<br>            <span class="hljs-comment">#存储精细网络的输出</span><br>            ret[<span class="hljs-string">&#x27;raw_fine&#x27;</span>]=raw_fine<br>        <span class="hljs-keyword">if</span> N_fine_samples&gt;<span class="hljs-number">0</span>:<br>            <span class="hljs-comment">#如果有精细网络，也要存粗网络的值，不然只有精细网络的值</span><br>            ret[<span class="hljs-string">&#x27;rgb_coarse_map&#x27;</span>]=rgb_coarse_map<br>            ret[<span class="hljs-string">&#x27;disp_coarse_map&#x27;</span>] = disp_coarse_map<br>            ret[<span class="hljs-string">&#x27;acc_coarse_map&#x27;</span>] = acc_coarse_map<br>            ret[<span class="hljs-string">&#x27;z_std&#x27;</span>] = torch.std(z_fine_vals,dim=-<span class="hljs-number">1</span>,unbiased=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-comment">#检测是否有异常值</span><br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> ret:<br>        <span class="hljs-keyword">if</span>(torch.isnan(ret[k]).<span class="hljs-built_in">any</span>())<span class="hljs-keyword">or</span> torch.isinf(ret[k].<span class="hljs-built_in">any</span>()) <span class="hljs-keyword">and</span> DEBUG:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;! [Numerical Error] <span class="hljs-subst">&#123;k&#125;</span> contains nan or inf.&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> ret<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">H, W, K,</span><br><span class="hljs-params">           chunk=<span class="hljs-number">1024</span>, <span class="hljs-comment">#原来的代码里默认值是1024*32 但光线才19200个 所以chunk改小一点</span></span><br><span class="hljs-params">           rays=<span class="hljs-literal">None</span>, c2w=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">           ndc=<span class="hljs-literal">True</span>,</span><br><span class="hljs-params">           near=<span class="hljs-number">0.0</span>,far=<span class="hljs-number">1.0</span>,</span><br><span class="hljs-params">           use_viewdirs=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">           c2w_staticcam=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">           **kwargs</span>):<br>    <span class="hljs-keyword">if</span> c2w <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># 根据c2w矩阵计算光线的起点和方向</span><br>        rays_o,rays_d = get_rays(H,W,K,c2w)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 否则默认光线为输入的光线 一般不会用到</span><br>        rays_o,rays_d = rays<br><br>    <span class="hljs-keyword">if</span> use_viewdirs:<br>        <span class="hljs-comment"># views方向和光线方向一直 可以认为是从theta、phi转化而来的</span><br>        viewsdirs = rays_d<br>        <span class="hljs-keyword">if</span> c2w_staticcam <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            rays_o,rays_d = get_rays(H,W,K,c2w_staticcam)<br>        <span class="hljs-comment"># 光线方向向量单位化</span><br>        viewsdirs = viewsdirs/torch.norm(viewsdirs,dim=-<span class="hljs-number">1</span>,keepdim=<span class="hljs-literal">True</span>)<br>        viewsdirs = torch.reshape(viewsdirs,[-<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]).<span class="hljs-built_in">float</span>()<br><br>    sh = rays_d.shape<br>    <span class="hljs-keyword">if</span> ndc:<br>        <span class="hljs-comment"># use normalized device coordinates</span><br>        <span class="hljs-comment"># Shift ray origins to near plane</span><br>        <span class="hljs-comment"># focal设为1 计算rays_</span><br>        rays_o,rays_d = ndc_rays(H,W,K[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>],<span class="hljs-number">1.0</span>,rays_o,rays_d)<br><br>    <span class="hljs-comment"># 创建batch大小的光线组</span><br>    <span class="hljs-comment"># batch_size x 3</span><br>    rays_o = torch.reshape(rays_o,[-<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]).<span class="hljs-built_in">float</span>()<br>    rays_d = torch.reshape(rays_d,[-<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]).<span class="hljs-built_in">float</span>()<br>    <span class="hljs-comment"># batch_szie x 1</span><br>    near , far = near * torch.ones_like(rays_d[...,:<span class="hljs-number">1</span>]) , far * torch.ones_like(rays_d[...,:<span class="hljs-number">1</span>])<br>    <span class="hljs-comment"># batch_size x (3+3+1+1) = batch_size x 8</span><br>    rays = torch.cat([rays_o,rays_d,near,far],-<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> use_viewdirs:<br>        <span class="hljs-comment"># batch_size * (3+3+1+1+3)</span><br>        rays =  torch.cat([rays,viewsdirs],-<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 渲染</span><br>    <span class="hljs-comment"># 再分一个小批次，防止爆显存</span><br>    <span class="hljs-comment"># rgb_fine_map, disp_fine_map, acc_fine_map, rgb_coarse_map, disp_coarse_map, acc_coarse_map, z_std</span><br>    all_ret = batchify_rays(rays,chunk,**kwargs)<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> all_ret:<br>        <span class="hljs-comment"># rgb_fine_map, disp_fine_map, acc_fine_map, rgb_coarse_map, disp_coarse_map, acc_coarse_map, z_std</span><br>        <span class="hljs-comment"># 都从</span><br>        <span class="hljs-comment"># [120 160] [3] --&gt; [120,160,3]</span><br>        k_sh = <span class="hljs-built_in">list</span>(sh[:-<span class="hljs-number">1</span>])+<span class="hljs-built_in">list</span>(all_ret[k].shape[<span class="hljs-number">1</span>:])<br>        <span class="hljs-comment"># [19200 3] --&gt; [120 160 3]</span><br>        all_ret[k]=torch.reshape(all_ret[k],k_sh)<br><br>    <span class="hljs-comment"># 所有的输出存到一个字典里</span><br>    k_extract = [<span class="hljs-string">&#x27;rgb_fine_map&#x27;</span>,<span class="hljs-string">&#x27;disp_fine_map&#x27;</span>,<span class="hljs-string">&#x27;acc_fine_map&#x27;</span>]<br>    ret_list = [all_ret[k] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> k_extract]<br>    ret_dict = &#123;k:all_ret[k] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> all_ret <span class="hljs-keyword">if</span> k <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> k_extract&#125;<br>    <span class="hljs-comment"># 返回的list 前三个是 [&#x27;rgb_fine_map&#x27;,&#x27;disp_fine_map&#x27;,&#x27;acc_fine_map&#x27;]</span><br>    <span class="hljs-comment"># 后四个是 [rgb_corse_map disp_corse_map acc_corse_map z_std]</span><br>    <span class="hljs-keyword">return</span> ret_list+[ret_dict]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">render_path</span>(<span class="hljs-params">render_poses,hwf,K,chunk,render_kwargs,gt_images=<span class="hljs-literal">None</span>,savedir=<span class="hljs-literal">None</span>,render_factor=<span class="hljs-number">0</span></span>):<br>   H, W, focal = hwf<br><br>   <span class="hljs-keyword">if</span> render_factor!=<span class="hljs-number">0</span>:<br>       <span class="hljs-comment">#下采样加速</span><br>       H = H //render_factor<br>       W = W //render_factor<br>       focal = focal / render_factor<br><br>   rgbs = []<br>   disps = []<br><br>   t = time.time()<br>   <span class="hljs-keyword">for</span> i, c2w <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tqdm(render_poses)):<br>       <span class="hljs-built_in">print</span>(i,time.time()-t)<br>       t = time.time()<br>       <span class="hljs-comment"># rgb, disp, acc, _ = render(H,W,K,chunk=chunk,c)</span><br>       rgb, disp, acc, _ = render(H, W, K, chunk=chunk, c2w=c2w[:<span class="hljs-number">3</span>, :<span class="hljs-number">4</span>], **render_kwargs)<br>       rgbs.append(rgb.cpu().numpy())<br>       disps.append(disp.cpu().numpy())<br>       <span class="hljs-keyword">if</span> i==<span class="hljs-number">0</span>:<br>           <span class="hljs-built_in">print</span>(rgb.shape,disp.shape)<br><br>       <span class="hljs-keyword">if</span> savedir <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>           rgb8 = to8b(rgbs[-<span class="hljs-number">1</span>])<br>           filename = os.path.join(savedir,<span class="hljs-string">&#x27;&#123;:03d&#125;.png&#x27;</span>.<span class="hljs-built_in">format</span>(i))<br>           imageio.imwrite(filename,rgb8)<br><br>   rgbs = np.stack(rgbs,<span class="hljs-number">0</span>)<br>   disps = np.stack(disps,<span class="hljs-number">0</span>)<br><br>   <span class="hljs-keyword">return</span> rgbs,disps<br><br></code></pre></td></tr></table></figure>





<h4 id="NeRF-model-py"><a href="#NeRF-model-py" class="headerlink" title="NeRF_model.py"></a>NeRF_model.py</h4><p>创建NeRF神经网络模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NeRF</span>(nn.Module):<br><br>    <span class="hljs-comment"># https://img-blog.csdnimg.cn/0380480cfc524f5e8d2df0bf19c9468a.png</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,D=<span class="hljs-number">8</span>,W=<span class="hljs-number">256</span>,input_channel=<span class="hljs-number">3</span>,input_views_channel=<span class="hljs-number">3</span>,output_channel=<span class="hljs-number">4</span>,skips=[<span class="hljs-number">4</span>],use_viewdirs=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        D: 深度，多少层网络</span><br><span class="hljs-string">        W: 网络内的channel 宽度</span><br><span class="hljs-string">        input_ch: xyz的宽度</span><br><span class="hljs-string">        input_ch_views: direction的宽度</span><br><span class="hljs-string">        output_ch: 这个参数尽在 use_viewdirs=False的时候会被使用</span><br><span class="hljs-string">        skips: 类似resnet的残差连接，表明在第几层进行连接</span><br><span class="hljs-string">        use_viewdirs:use full 5D input instead of 3D  对 x,y,z ,theta , phi 都输入，都编码</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">super</span>(NeRF,self).__init__()<br>        <span class="hljs-comment"># 网络的深度(层数) 一共8层</span><br>        self.D = D<br>        <span class="hljs-comment"># 网络的宽度</span><br>        self.W = W<br>        <span class="hljs-comment"># x y z 位置</span><br>        self.input_channel = input_channel<br>        <span class="hljs-comment"># theta phi 角度</span><br>        self.input_views_channel = input_views_channel<br>        <span class="hljs-comment"># 在4层有跳跃连接</span><br>        self.skips = skips<br>        <span class="hljs-comment">#</span><br>        self.use_viewdirs = use_viewdirs<br><br>        <span class="hljs-comment">#构建MLP</span><br>        <span class="hljs-comment"># todo 这个网络的构造还要再去看一下</span><br>        <span class="hljs-comment"># 看完了</span><br>        self.pts_linears = nn.ModuleList(<br>            [nn.Linear(input_channel,W)]+[nn.Linear(W,W) <span class="hljs-keyword">if</span> i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.skips <span class="hljs-keyword">else</span> nn.Linear(W+input_channel,W) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(D-<span class="hljs-number">1</span>)]<br>        )<br><br>        self.views_linears = nn.ModuleList(<br>            [nn.Linear(input_views_channel+W,W//<span class="hljs-number">2</span>)]<br>        )<br><br>        <span class="hljs-keyword">if</span> use_viewdirs:<br>            <span class="hljs-comment"># 特征 256 in 256 out</span><br>            self.feature_linear = nn.Linear(W,W)<br>            <span class="hljs-comment"># 透明度 256 in 1 out</span><br>            self.alpha_linear = nn.Linear(W,<span class="hljs-number">1</span>)<br>            <span class="hljs-comment"># rgb 128 in 3 out</span><br>            self.rgb_linear = nn.Linear(W//<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)<br>        <span class="hljs-keyword">else</span>:<br>            self.output_linear = nn.Linear(W,output_channel)<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self,x</span>):<br><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        这段代码实现了一个神经网络模型的前向传播过程，用于对输入数据进行处理并输出预测结果。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        该模型接受一个大小为 x 的输入张量，其中 input_channel 表示输入点云的通道数，input_views_channel 表示输入视角的通道数。</span><br><span class="hljs-string">        首先，使用 torch.split 函数将输入张量分为两部分，分别表示点云和视角。其中 dim=-1 表示沿着最后一个维度进行分割。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        接下来，将点云数据输入到一个由多个全连接层组成的神经网络中。</span><br><span class="hljs-string">        在每一层中，将先将点云数据传递到一个全连接层 self.pts_linears[i] 中，然后使用 ReLU 激活函数 F.relu() 对其进行非线性变换。</span><br><span class="hljs-string">        如果当前层的索引值在 self.skips 集合中，则会在经过非线性变换之后将原始的输入点云数据 input_pts 与变换后的结果进行拼接。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        如果模型使用视角数据，则将该数据与点云数据经过一系列的全连接层和非线性激活函数进行处理。</span><br><span class="hljs-string">        具体来说，将点云数据 h 输入到一个全连接层 self.alpha_linear 和 self.feature_linear 中，得到相应的特征向量 alpha 和 feature。</span><br><span class="hljs-string">        然后将特征向量和视角数据 input_views 进行拼接，并经过多个全连接层和非线性激活函数的变换，最终得到预测的输出结果。</span><br><span class="hljs-string">        如果模型不使用视角数据，则直接将点云数据经过一系列的全连接层和非线性激活函数处理，得到预测的输出结果。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        最后，将输出结果 outputs 返回。</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        这段代码使用了 PyTorch 中的 torch.split() 函数将输入张量 x 按照指定的维度进行切分。</span><br><span class="hljs-string">        具体来说，x 被切分成两部分，分别被赋值给变量 input_pts 和 input_views。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        函数的第一个参数 x 是要被切分的张量。第二个参数 [63, 27] 是一个长度为 2 的列表，用于指定切分后每个小张量在切分维度上的大小。</span><br><span class="hljs-string">        在这个例子中，dim=-1 表示沿着最后一个维度进行切分，也就是将 x 张量在最后一个维度上切分成两个小张量，</span><br><span class="hljs-string">        其中 input_pts 张量大小为 63，在最后一个维度上的索引范围为 0-62，而 input_views 张量大小为 27，在最后一个维度上的索引范围为 63-89。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        因此，在这段代码中，input_pts 和 input_views 分别表示输入张量 x 的前 63 个元素和后 27 个元素，可以用于分别处理点云和视角数据。</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        input_pts,input_views = torch.split(x,[self.input_channel,self.input_views_channel],dim=-<span class="hljs-number">1</span>)<br><br>        h = input_pts<br><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        在这段代码中，变量 l 是一个占位符，用于表示当前迭代的循环层。</span><br><span class="hljs-string">        由于在这个循环中，只使用了 i 变量，而没有使用 l 变量，所以可以省略它而不影响代码的功能。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        具体来说，在这段代码中，enumerate(self.pts_linears) 返回了一个由 (index, element) 组成的元组序列，</span><br><span class="hljs-string">        其中 index 表示当前元素在序列中的索引位置，element 表示序列中的当前元素。</span><br><span class="hljs-string">        在每次迭代中，变量 i 被赋值为当前元素的索引位置，而变量 l 被赋值为当前元素。</span><br><span class="hljs-string">        但是由于这段代码中没有使用 l 变量，因此在代码实现中可以将其省略掉，只保留 i 变量的使用。</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">for</span> i ,l <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.pts_linears):<br>            h = self.pts_linears[i](h)<br>            h = F.relu(h)<br><br>            <span class="hljs-keyword">if</span> i <span class="hljs-keyword">in</span> self.skips:<br>                h = torch.cat([input_pts,h],-<span class="hljs-number">1</span>)<br><br>        <span class="hljs-keyword">if</span> self.use_viewdirs:<br>            alpha = self.alpha_linear(h)<br>            feature = self.feature_linear(h)<br>            h=torch.cat([feature,input_views],-<span class="hljs-number">1</span>)<br><br>            <span class="hljs-keyword">for</span> i,l <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.views_linears):<br>                h = self.views_linears[i](h)<br>                h = F.relu(h)<br><br>            rgb = self.rgb_linear(h)<br>            outputs = torch.cat([rgb,alpha],-<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">else</span>:<br>            outputs = self.output_linear(h)<br><br><br>        <span class="hljs-keyword">return</span> outputs<br></code></pre></td></tr></table></figure>





<h4 id="rays-py"><a href="#rays-py" class="headerlink" title="rays.py"></a>rays.py</h4><p><em>ndc_rays：</em>看不懂</p>
<p><em>get_rays：</em>将<code>H、W、K、focal</code>转为<code>rays_o、rays_d</code></p>
<p><em>get_rays_np：</em>将<code>H、W、K、focal</code>转为<code>rays_o、rays_d</code>，<code>numpy</code>库实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ndc_rays</span>(<span class="hljs-params">H,W,focal,near,rays_o,rays_d</span>):<br>    <span class="hljs-comment">#这个函数没有好好理解</span><br>    <span class="hljs-comment"># Shift ray origins to near plane</span><br>    t = -(near + rays_o[..., <span class="hljs-number">2</span>]) / rays_d[..., <span class="hljs-number">2</span>]<br>    rays_o = rays_o + t[..., <span class="hljs-literal">None</span>] * rays_d<br><br>    <span class="hljs-comment"># Projection</span><br>    o0 = -<span class="hljs-number">1.</span> / (W / (<span class="hljs-number">2.</span> * focal)) * rays_o[..., <span class="hljs-number">0</span>] / rays_o[..., <span class="hljs-number">2</span>]<br>    o1 = -<span class="hljs-number">1.</span> / (H / (<span class="hljs-number">2.</span> * focal)) * rays_o[..., <span class="hljs-number">1</span>] / rays_o[..., <span class="hljs-number">2</span>]<br>    o2 = <span class="hljs-number">1.</span> + <span class="hljs-number">2.</span> * near / rays_o[..., <span class="hljs-number">2</span>]<br><br>    d0 = -<span class="hljs-number">1.</span> / (W / (<span class="hljs-number">2.</span> * focal)) * (rays_d[..., <span class="hljs-number">0</span>] / rays_d[..., <span class="hljs-number">2</span>] - rays_o[..., <span class="hljs-number">0</span>] / rays_o[..., <span class="hljs-number">2</span>])<br>    d1 = -<span class="hljs-number">1.</span> / (H / (<span class="hljs-number">2.</span> * focal)) * (rays_d[..., <span class="hljs-number">1</span>] / rays_d[..., <span class="hljs-number">2</span>] - rays_o[..., <span class="hljs-number">1</span>] / rays_o[..., <span class="hljs-number">2</span>])<br>    d2 = -<span class="hljs-number">2.</span> * near / rays_o[..., <span class="hljs-number">2</span>]<br><br>    rays_o = torch.stack([o0, o1, o2], -<span class="hljs-number">1</span>)<br>    rays_d = torch.stack([d0, d1, d2], -<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">return</span> rays_o, rays_d<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_rays</span>(<span class="hljs-params">H,W,K,c2w</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    :param H: 高</span><br><span class="hljs-string">    :param W: 宽</span><br><span class="hljs-string">    :param K: 内参矩阵</span><br><span class="hljs-string">    :param c2w: 相机坐标系到世界坐标系转换矩阵， 相机位姿</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    torch.linspace(start, end, steps=100, out=None) → Tensor</span><br><span class="hljs-string">    返回一个1维张量，包含在区间start和end上均匀间隔的step个点。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    i,j = torch.meshgrid(torch.linspace(<span class="hljs-number">0</span>,W-<span class="hljs-number">1</span>,W),torch.linspace(<span class="hljs-number">0</span>,H-<span class="hljs-number">1</span>,H),indexing=<span class="hljs-string">&#x27;ij&#x27;</span>)<br><br>    i = i.t()<br>    j = j.t()<br>    <span class="hljs-comment"># [378,504,3]</span><br>    <span class="hljs-comment"># 射线方向的计算公式</span><br>    dirs = torch.stack([(i-K[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>])/K[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>],-(j-K[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>])/K[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>],-torch.ones_like(i)],-<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># dirs[...,np.newaxis,:]  378 x 504 x 1 x 3</span><br>    <span class="hljs-comment"># c2w[:3,:3] 3 x 3</span><br>    <span class="hljs-comment"># dirs[...,np.newaxis,:]*c2w[:3,:3] 378 x 504 x 3 x 3</span><br>    <span class="hljs-comment"># 3x3 按列压缩 为 rays_d 378 x 504 x 3</span><br>    rays_d = torch.<span class="hljs-built_in">sum</span>(dirs[...,np.newaxis,:]*c2w[:<span class="hljs-number">3</span>,:<span class="hljs-number">3</span>],-<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 3 -&gt; 378 x 504 x 3</span><br>    rays_o = c2w[:<span class="hljs-number">3</span>,-<span class="hljs-number">1</span>].expand(rays_d.shape)<br>    <span class="hljs-keyword">return</span> rays_o,rays_d<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_rays_np</span>(<span class="hljs-params">H,W,K,c2w</span>):<br>    <span class="hljs-comment"># get_rays方法的numpy实现</span><br>    i,j = np.meshgrid(np.arange(W,dtype=np.float32),np.arange(H,dtype=np.float32),indexing=<span class="hljs-string">&#x27;xy&#x27;</span>)<br><br>    dirs = np.stack([(i-K[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>])/K[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>],-(j-K[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>])/K[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>],-np.ones_like(i)],-<span class="hljs-number">1</span>)<br>    rays_d = np.<span class="hljs-built_in">sum</span>(dirs[...,np.newaxis,:]*c2w[:<span class="hljs-number">3</span>,:<span class="hljs-number">3</span>],-<span class="hljs-number">1</span>)<br>    rays_o = np.broadcast_to(c2w[:<span class="hljs-number">3</span>,-<span class="hljs-number">1</span>],np.shape(rays_d))<br>    <span class="hljs-keyword">return</span> rays_o,rays_d<br></code></pre></td></tr></table></figure>



<h4 id="embed-py"><a href="#embed-py" class="headerlink" title="embed.py"></a>embed.py</h4><p>对输入的$x,y,z,\theta,\phi$ 进行高频位置编码</p>
<p>$x\quad y\quad z : 3 \times 2 \times 10 + 3 = 63$</p>
<p>$\theta \quad \phi:  3 \times 2 \times 4 + 3 = 27$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><br><span class="hljs-comment"># 结合神经网络结构的图来看</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Embedder</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,**kwargs</span>):<br>        self.kwargs = kwargs<br>        self.create_embedding_fn()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_embedding_fn</span>(<span class="hljs-params">self</span>):<br>        embed_fns = []<br>        d = self.kwargs[<span class="hljs-string">&#x27;input_dims&#x27;</span>]<br>        out_dim = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">if</span> self.kwargs[<span class="hljs-string">&#x27;include_input&#x27;</span>]:<br>        <span class="hljs-comment"># 包含输入的话 60+3 就是加的这个3</span><br>            embed_fns.append(<span class="hljs-keyword">lambda</span> x:x)<br>            out_dim +=d<br><br>        <span class="hljs-comment"># 2 ** 0 ~ 2 ** 9</span><br>        max_freq = self.kwargs[<span class="hljs-string">&#x27;max_freq_log2&#x27;</span>]<br>        N_freqs = self.kwargs[<span class="hljs-string">&#x27;num_freqs&#x27;</span>]<br><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        线性编码是将位置坐标与一个频率向量进行点积得到的，其中频率向量中的每个元素都是等间距的。</span><br><span class="hljs-string">        例如，在一维情况下，频率向量可以是 [1, 2, 3, ..., N]，其中 N 是编码的维度。</span><br><span class="hljs-string">        这种线性编码在表示位置信息时，对不同尺度的特征没有明显的区分。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        对数编码是将位置坐标与一个频率向量进行点积得到的，其中频率向量中的每个元素都是通过对数函数计算得到的。</span><br><span class="hljs-string">        例如，在一维情况下，频率向量可以是 [2^0, 2^1, 2^2, ..., 2^(N-1)]，其中 N 是编码的维度。</span><br><span class="hljs-string">        这种对数编码可以将不同尺度的变化映射到编码向量的不同维度，从而使得位置编码能够更好地表示不同尺度的特征。</span><br><span class="hljs-string"></span><br><span class="hljs-string">        因此，对数编码与线性编码的区别在于编码向量中元素的间隔不同，对数编码能够更好地表示不同尺度的特征，而线性编码则无法明显地区分不同尺度的特征。</span><br><span class="hljs-string">        在 NeRF 中使用对数编码的位置编码，可以更好地处理从不同角度观察的场景，并减少渲染中的混淆。</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment">#是否采用对数编码</span><br>        <span class="hljs-comment"># torch.linspace(start, end, steps=100, out=None) → Tensor</span><br>        <span class="hljs-comment"># 返回一个1维张量，包含在区间start和end上均匀间隔的step个点。</span><br>        <span class="hljs-keyword">if</span> self.kwargs[<span class="hljs-string">&#x27;log_sampling&#x27;</span>]:<br>            <span class="hljs-comment">#对数编码</span><br>            <span class="hljs-comment"># 2 ** 0~9之间10个点</span><br>            freq_bands = <span class="hljs-number">2.0</span> ** torch.linspace(<span class="hljs-number">0.0</span>,max_freq,steps=N_freqs)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># 线性编码</span><br>            freq_bands = torch.linspace(<span class="hljs-number">2.0</span>**<span class="hljs-number">0.0</span>,<span class="hljs-number">2</span>** max_freq,steps=N_freqs)<br><br>        <span class="hljs-keyword">for</span> freq <span class="hljs-keyword">in</span> freq_bands:<br>            <span class="hljs-keyword">for</span> p_fn <span class="hljs-keyword">in</span> self.kwargs[<span class="hljs-string">&#x27;periodic_fns&#x27;</span>]:<br>                <span class="hljs-comment"># p_fn [sin(),cos()]</span><br>                <span class="hljs-comment"># embed_fns [sinx sin2x ...sin512x; cosx,cos2x...cos512x]</span><br>                embed_fns.append(<span class="hljs-keyword">lambda</span> x,p_fn=p_fn,freq=freq:p_fn(x*freq))<br>                out_dim+=d<br><br>        self.embed_fns =embed_fns<br>        self.out_dim = out_dim<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">embed</span>(<span class="hljs-params">self,inputs</span>):<br>        <span class="hljs-comment"># 把位置编码的变化拼接起来</span><br>        <span class="hljs-keyword">return</span> torch.cat([fn(inputs) <span class="hljs-keyword">for</span> fn <span class="hljs-keyword">in</span> self.embed_fns],-<span class="hljs-number">1</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_embedder</span>(<span class="hljs-params">multires,i=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> i==-<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> nn.Identity(),<span class="hljs-number">3</span><br><br>    <span class="hljs-comment"># 设置位置编码的参数</span><br>    embed_kwargs=&#123;<br>        <span class="hljs-string">&#x27;include_input&#x27;</span>:<span class="hljs-literal">True</span>,<br>        <span class="hljs-string">&#x27;input_dims&#x27;</span>:<span class="hljs-number">3</span>,<br>        <span class="hljs-string">&#x27;max_freq_log2&#x27;</span>:multires-<span class="hljs-number">1</span>,<br>        <span class="hljs-string">&#x27;num_freqs&#x27;</span>:multires,<br>        <span class="hljs-string">&#x27;log_sampling&#x27;</span>:<span class="hljs-literal">False</span>,<br>        <span class="hljs-string">&#x27;periodic_fns&#x27;</span>:[torch.sin,torch.cos],<br>    &#125;<br><br>    embedder_obj = Embedder(**embed_kwargs)<br>    embed = <span class="hljs-keyword">lambda</span> x,eo=embedder_obj:eo.embed(x)<br><br>    <span class="hljs-keyword">return</span> embed,embedder_obj.out_dim<br></code></pre></td></tr></table></figure>







<h4 id="sample-pdf-py"><a href="#sample-pdf-py" class="headerlink" title="sample_pdf.py"></a>sample_pdf.py</h4><p><em>sample_pdf：</em>精细采样，再粗采样的基础上根据概率密度函数<code>pdf</code>计算精细的采样点的位置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><br><span class="hljs-comment"># Hierarchical sampling (section 5.2)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sample_pdf</span>(<span class="hljs-params">bins, weights, N_samples, det=<span class="hljs-literal">False</span>, pytest=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    bins: z_vals_mid</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># Get pdf</span><br>    weights = weights + <span class="hljs-number">1e-5</span>  <span class="hljs-comment"># prevent nans</span><br>    <span class="hljs-comment"># 归一化 [bs, 62]</span><br>    <span class="hljs-comment"># 概率密度函数</span><br>    pdf = weights / torch.<span class="hljs-built_in">sum</span>(weights, -<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 累积分布函数</span><br>    cdf = torch.cumsum(pdf, -<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 在第一个位置补0</span><br>    cdf = torch.cat([torch.zeros_like(cdf[..., :<span class="hljs-number">1</span>]), cdf], -<span class="hljs-number">1</span>)  <span class="hljs-comment"># (batch, len(bins))</span><br><br>    <span class="hljs-comment"># Take uniform samples</span><br>    <span class="hljs-keyword">if</span> det:<br>        u = torch.linspace(<span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, steps=N_samples)<br>        u = u.expand(<span class="hljs-built_in">list</span>(cdf.shape[:-<span class="hljs-number">1</span>]) + [N_samples])<br>    <span class="hljs-keyword">else</span>:<br>        u = torch.rand(<span class="hljs-built_in">list</span>(cdf.shape[:-<span class="hljs-number">1</span>]) + [N_samples])  <span class="hljs-comment"># [bs,128]</span><br><br>    <span class="hljs-comment"># Pytest, overwrite u with numpy&#x27;s fixed random numbers</span><br>    <span class="hljs-keyword">if</span> pytest:<br>        np.random.seed(<span class="hljs-number">0</span>)<br>        new_shape = <span class="hljs-built_in">list</span>(cdf.shape[:-<span class="hljs-number">1</span>]) + [N_samples]<br>        <span class="hljs-keyword">if</span> det:<br>            u = np.linspace(<span class="hljs-number">0.</span>, <span class="hljs-number">1.</span>, N_samples)<br>            u = np.broadcast_to(u, new_shape)<br>        <span class="hljs-keyword">else</span>:<br>            u = np.random.rand(*new_shape)<br>        u = torch.Tensor(u)<br><br>    <span class="hljs-comment"># Invert CDF</span><br><br>    u = u.contiguous()<br>    <span class="hljs-comment"># u 是随机生成的</span><br>    <span class="hljs-comment"># 找到对应的插入的位置</span><br>    inds = torch.searchsorted(cdf, u, right=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment"># 前一个位置，为了防止inds中的0的前一个是-1，这里就还是0</span><br>    below = torch.<span class="hljs-built_in">max</span>(torch.zeros_like(inds - <span class="hljs-number">1</span>), inds - <span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 最大的位置就是cdf的上限位置，防止过头，跟上面的意义相同</span><br>    above = torch.<span class="hljs-built_in">min</span>((cdf.shape[-<span class="hljs-number">1</span>] - <span class="hljs-number">1</span>) * torch.ones_like(inds), inds)<br>    <span class="hljs-comment"># (batch, N_samples, 2)</span><br>    inds_g = torch.stack([below, above], -<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># cdf_g = tf.gather(cdf, inds_g, axis=-1, batch_dims=len(inds_g.shape)-2)</span><br>    <span class="hljs-comment"># bins_g = tf.gather(bins, inds_g, axis=-1, batch_dims=len(inds_g.shape)-2)</span><br>    <span class="hljs-comment"># (batch, N_samples, 63)</span><br>    matched_shape = [inds_g.shape[<span class="hljs-number">0</span>], inds_g.shape[<span class="hljs-number">1</span>], cdf.shape[-<span class="hljs-number">1</span>]]<br>    <span class="hljs-comment"># 如[1024,128,63] 提取 根据 inds_g[i][j][0] inds_g[i][j][1]</span><br>    <span class="hljs-comment"># cdf_g [1024,128,2]</span><br>    cdf_g = torch.gather(cdf.unsqueeze(<span class="hljs-number">1</span>).expand(matched_shape), <span class="hljs-number">2</span>, inds_g)<br>    <span class="hljs-comment"># 如上, bins 是从2到6的采样点，是64个点的中间值</span><br>    bins_g = torch.gather(bins.unsqueeze(<span class="hljs-number">1</span>).expand(matched_shape), <span class="hljs-number">2</span>, inds_g)<br>    <span class="hljs-comment"># 差值</span><br>    denom = (cdf_g[..., <span class="hljs-number">1</span>] - cdf_g[..., <span class="hljs-number">0</span>])<br>    <span class="hljs-comment"># 防止过小</span><br>    denom = torch.where(denom &lt; <span class="hljs-number">1e-5</span>, torch.ones_like(denom), denom)<br><br>    t = (u - cdf_g[..., <span class="hljs-number">0</span>]) / denom<br><br>    <span class="hljs-comment"># lower+线性插值</span><br>    samples = bins_g[..., <span class="hljs-number">0</span>] + t * (bins_g[..., <span class="hljs-number">1</span>] - bins_g[..., <span class="hljs-number">0</span>])<br><br>    <span class="hljs-keyword">return</span> samples<br></code></pre></td></tr></table></figure>



<h4 id="load-llff-data-py"><a href="#load-llff-data-py" class="headerlink" title="load_llff_data.py"></a>load_llff_data.py</h4><p><strong>不写了，总的来说就是从llff的位姿文件中解算pose数据</strong></p>
<p><em>load_llff_data</em></p>
<p><em>get_poses_bds_imgs</em></p>
<p><em>_minify</em></p>
<p><em>imread</em></p>
<p><em>recenter_poses</em></p>
<p><em>poses_average</em></p>
<p><em>normalize</em></p>
<p><em>normalize_c2w_matrix</em></p>
<p><em>spherify_poses</em></p>
<p><em>render_path_spiral</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> os,imageio<br><span class="hljs-keyword">from</span> subprocess <span class="hljs-keyword">import</span> check_output<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">render_path_spiral</span>(<span class="hljs-params">c2w, up, rads, focal, zdelta, zrate, rots, N</span>):<br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># 这个函数没有详细理解</span><br>    render_poses = []<br>    rads = np.array(<span class="hljs-built_in">list</span>(rads) + [<span class="hljs-number">1.</span>])<br>    hwf = c2w[:, <span class="hljs-number">4</span>:<span class="hljs-number">5</span>]<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    c是当前迭代的相机在世界坐标系的位置， </span><br><span class="hljs-string">    np.dot(c2w[:3, :4], np.array([0, 0, -focal, 1.])是焦点在世界坐标系的位置</span><br><span class="hljs-string">    z是相机z轴在世界坐标系的朝向。</span><br><span class="hljs-string">    normalize_c2w_matrix(z, up, c)构造当前相机的参数矩阵。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">for</span> theta <span class="hljs-keyword">in</span> np.linspace(<span class="hljs-number">0.</span>, <span class="hljs-number">2.</span> * np.pi * rots, N + <span class="hljs-number">1</span>)[:-<span class="hljs-number">1</span>]:<br>        c = np.dot(c2w[:<span class="hljs-number">3</span>, :<span class="hljs-number">4</span>], np.array([np.cos(theta), -np.sin(theta), -np.sin(theta * zrate), <span class="hljs-number">1.</span>]) * rads)<br>        z = normalize(c - np.dot(c2w[:<span class="hljs-number">3</span>, :<span class="hljs-number">4</span>], np.array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -focal, <span class="hljs-number">1.</span>])))<br>        render_poses.append(np.concatenate([normalize_c2w_matrix(z, up, c), hwf], <span class="hljs-number">1</span>))<br>    <span class="hljs-keyword">return</span> render_poses<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">spherify_poses</span>(<span class="hljs-params">poses, bds</span>):<br>    <span class="hljs-comment"># 这个函数没有详细理解</span><br>    <span class="hljs-comment">#用于&quot;球面化&quot;相机分布并返回一个环绕的相机轨迹用于新视角合成</span><br>    p34_to_44 = <span class="hljs-keyword">lambda</span> p: np.concatenate([p, np.tile(np.reshape(np.eye(<span class="hljs-number">4</span>)[-<span class="hljs-number">1</span>, :], [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>]), [p.shape[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])], <span class="hljs-number">1</span>)<br><br>    rays_d = poses[:, :<span class="hljs-number">3</span>, <span class="hljs-number">2</span>:<span class="hljs-number">3</span>]<br>    rays_o = poses[:, :<span class="hljs-number">3</span>, <span class="hljs-number">3</span>:<span class="hljs-number">4</span>]<br><br>    <span class="hljs-comment">#找到离所有相机中心射线距离之和最短的点（可以先简单理解成场景的中心位置）</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">min_line_dist</span>(<span class="hljs-params">rays_o, rays_d</span>):<br>        A_i = np.eye(<span class="hljs-number">3</span>) - rays_d * np.transpose(rays_d, [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>])<br>        b_i = -A_i @ rays_o<br>        pt_mindist = np.squeeze(-np.linalg.inv((np.transpose(A_i, [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>]) @ A_i).mean(<span class="hljs-number">0</span>)) @ (b_i).mean(<span class="hljs-number">0</span>))<br>        <span class="hljs-keyword">return</span> pt_mindist<br><br>    pt_mindist = min_line_dist(rays_o, rays_d)<br><br>    <span class="hljs-comment">#将得到的场景中心位置移到世界坐标系的原点，同时将所有相机z轴的平均方向转到和世界坐标系的z轴相同</span><br>    center = pt_mindist<br>    up = (poses[:, :<span class="hljs-number">3</span>, <span class="hljs-number">3</span>] - center).mean(<span class="hljs-number">0</span>)<br><br>    vec0 = normalize(up)<br>    vec1 = normalize(np.cross([<span class="hljs-number">.1</span>, <span class="hljs-number">.2</span>, <span class="hljs-number">.3</span>], vec0))<br>    vec2 = normalize(np.cross(vec0, vec1))<br>    pos = center<br>    c2w = np.stack([vec1, vec2, vec0, pos], <span class="hljs-number">1</span>)<br><br>    poses_reset = np.linalg.inv(p34_to_44(c2w[<span class="hljs-literal">None</span>])) @ p34_to_44(poses[:, :<span class="hljs-number">3</span>, :<span class="hljs-number">4</span>])<br><br>    <span class="hljs-comment">#最后将相机的位置缩放到单位圆内</span><br>    rad = np.sqrt(np.mean(np.<span class="hljs-built_in">sum</span>(np.square(poses_reset[:, :<span class="hljs-number">3</span>, <span class="hljs-number">3</span>]), -<span class="hljs-number">1</span>)))<br><br>    sc = <span class="hljs-number">1.</span> / rad<br>    poses_reset[:, :<span class="hljs-number">3</span>, <span class="hljs-number">3</span>] *= sc<br>    bds *= sc<br>    rad *= sc<br><br>    centroid = np.mean(poses_reset[:, :<span class="hljs-number">3</span>, <span class="hljs-number">3</span>], <span class="hljs-number">0</span>)<br>    zh = centroid[<span class="hljs-number">2</span>]<br>    radcircle = np.sqrt(rad ** <span class="hljs-number">2</span> - zh ** <span class="hljs-number">2</span>)<br>    new_poses = []<br><br>    <span class="hljs-keyword">for</span> th <span class="hljs-keyword">in</span> np.linspace(<span class="hljs-number">0.</span>, <span class="hljs-number">2.</span> * np.pi, <span class="hljs-number">120</span>):<br>        camorigin = np.array([radcircle * np.cos(th), radcircle * np.sin(th), zh])<br>        up = np.array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1.</span>])<br><br>        vec2 = normalize(camorigin)<br>        vec0 = normalize(np.cross(vec2, up))<br>        vec1 = normalize(np.cross(vec2, vec0))<br>        pos = camorigin<br>        p = np.stack([vec0, vec1, vec2, pos], <span class="hljs-number">1</span>)<br><br>        new_poses.append(p)<br><br>    new_poses = np.stack(new_poses, <span class="hljs-number">0</span>)<br><br>    new_poses = np.concatenate([new_poses, np.broadcast_to(poses[<span class="hljs-number">0</span>, :<span class="hljs-number">3</span>, -<span class="hljs-number">1</span>:], new_poses[:, :<span class="hljs-number">3</span>, -<span class="hljs-number">1</span>:].shape)], -<span class="hljs-number">1</span>)<br>    poses_reset = np.concatenate(<br>        [poses_reset[:, :<span class="hljs-number">3</span>, :<span class="hljs-number">4</span>], np.broadcast_to(poses[<span class="hljs-number">0</span>, :<span class="hljs-number">3</span>, -<span class="hljs-number">1</span>:], poses_reset[:, :<span class="hljs-number">3</span>, -<span class="hljs-number">1</span>:].shape)], -<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">return</span> poses_reset, new_poses, bds<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_c2w_matrix</span>(<span class="hljs-params">norm_z,norm_y,mean_center</span>):<br>    <span class="hljs-comment"># [vec_X,vec_Y,vec_Z,center]</span><br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    原函数 里面有点看不懂</span><br><span class="hljs-string">    def viewmatrix(z, up, pos):</span><br><span class="hljs-string">    vec2 = normalize(z)</span><br><span class="hljs-string">    vec1_avg = up</span><br><span class="hljs-string">    vec0 = normalize(np.cross(vec1_avg, vec2))</span><br><span class="hljs-string">    vec1 = normalize(np.cross(vec2, vec0))</span><br><span class="hljs-string">    m = np.stack([vec0, vec1, vec2, pos], 1)</span><br><span class="hljs-string">    return m</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 拷贝一份</span><br>    norm_vec_z = nomailize(norm_z)<br>    norm_vec_y = norm_y<br>    norm_vec_x = normalize(np.cross(norm_vec_y,norm_vec_z))<br>    <span class="hljs-comment"># todo 为什么y还要再算一遍？</span><br>    norm_vec_y = normalize(np.cross(norm_vec_z,norm_vec_x))<br>    c2w = np.stack([norm_vec_x,norm_vec_y,norm_z,mean_center],<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> c2w<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">return</span> x/np.linalg.norm(x)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">poses_average</span>(<span class="hljs-params">poses</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param</span><br><span class="hljs-string">    poses: [vec_X,vec_Y,vec_Z,center,hwf] 也叫C2W矩阵</span><br><span class="hljs-string">    :return: c2w camera to world</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># 获取照片的 高、宽、焦距</span><br>    hwf = poses[<span class="hljs-number">0</span>,:<span class="hljs-number">3</span>,-<span class="hljs-number">1</span>:]<br>    <span class="hljs-comment"># 获取相机位置的center平均（中心） 相机位置 第四列 (x,y,z)</span><br>    mean_center = poses[:,:<span class="hljs-number">3</span>,<span class="hljs-number">3</span>].mean(<span class="hljs-number">0</span>)<br>    <span class="hljs-comment"># 对所有相机的Z轴的方向向量 归一化</span><br>    norm_z = normalize(poses[:,:<span class="hljs-number">3</span>,<span class="hljs-number">2</span>].<span class="hljs-built_in">sum</span>(<span class="hljs-number">0</span>))<br>    <span class="hljs-comment"># 对所有相机的Y轴的方向向量 归一化</span><br>    norm_y = poses[:,:<span class="hljs-number">3</span>,<span class="hljs-number">1</span>].<span class="hljs-built_in">sum</span>(<span class="hljs-number">0</span>)<br>    <span class="hljs-comment"># 相机坐标系X轴方向与X和Y方向垂直，所以不用计算</span><br>    poses = np.concatenate([normalize_c2w_matrix(norm_z,norm_y,mean_center),hwf],<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> poses<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">recenter_poses</span>(<span class="hljs-params">poses</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param poses:  相机所有的位姿数据</span><br><span class="hljs-string">    :return:</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    首先我们要知道利用同一个旋转平移变换矩阵左乘所有的相机位姿是对所有的相机位姿做一个全局的旋转平移变换</span><br><span class="hljs-string">    我们可以用平均相机位姿作为支点理解，</span><br><span class="hljs-string">    如果把平均位姿的逆c2w^-1左乘平均相机位姿pose_avg，返回的相机位姿中旋转矩阵为单位矩阵，平移量为零向量。</span><br><span class="hljs-string">    也就是变换后的平均相机位姿的位置处在世界坐标系的原点，XYZ轴朝向和世界坐标系的向一致。</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 拷贝一份</span><br>    poses_ = poses+<span class="hljs-number">0</span><br>    <span class="hljs-comment"># 创建 1 x 4 的ndarray</span><br>    bottom = np.reshape([<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1.0</span>],[<span class="hljs-number">1</span>,<span class="hljs-number">4</span>])<br>    <span class="hljs-comment"># 多个输入相机的归一化相机坐标轴、相机位置的均值 poses_avg 3 x 5</span><br>    poses_avg = poses_average(poses)<br>    <span class="hljs-comment"># 多个输入相机的平均位姿c2w_avg 4 x 4</span><br>    c2w_avg = np.concatenate([poses_avg[:<span class="hljs-number">3</span>,:<span class="hljs-number">4</span>],bottom],<span class="hljs-number">0</span>)<br>    <span class="hljs-comment"># 将bottom从1x4 变为 20 x 4 方便拼到 poses里</span><br>    <span class="hljs-comment"># todo  np.tile函数</span><br>    bottom = np.tile(np.reshape(bottom, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>]), [poses.shape[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br>    <span class="hljs-comment"># poses 20 x 3 x 5 --&gt; 20 x 4 x 4</span><br>    poses = np.concatenate([poses[:,:<span class="hljs-number">3</span>,:<span class="hljs-number">4</span>],bottom],-<span class="hljs-number">2</span>)<br>    <span class="hljs-comment"># c2w平均位姿的逆矩阵左乘所有的相机位姿</span><br>    <span class="hljs-comment"># 返回的相机位姿中旋转矩阵为单位矩阵，平移量为零向量</span><br>    <span class="hljs-comment"># 变换后的平均相机位姿的位置处在世界坐标系的原点，XYZ轴朝向和世界坐标系的向一致。</span><br>    poses = np.linalg.inv(c2w_avg) @ poses<br>    <span class="hljs-comment"># 把备份的poses_的位姿数据替换</span><br>    poses_[:, :<span class="hljs-number">3</span>, :<span class="hljs-number">4</span>] = poses[:, :<span class="hljs-number">3</span>, :<span class="hljs-number">4</span>]<br>    <span class="hljs-comment"># 把最后的HWF 第五列还原上</span><br>    poses = poses_<br>    <span class="hljs-keyword">return</span> poses<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">imread</span>(<span class="hljs-params">file</span>):<br>    <span class="hljs-keyword">if</span> file.endswith(<span class="hljs-string">&quot;png&quot;</span>):<br>        <span class="hljs-keyword">return</span> imageio.imread(file,ignoregamma=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> imageio.imread(file)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_minify</span>(<span class="hljs-params">datadir,factors=[],resolutions=[]</span>):<br>    <span class="hljs-comment"># 预先定义一个是否需要加载img文件夹的bool变量</span><br>    needtoload = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">for</span> factor <span class="hljs-keyword">in</span> factors:<br>        <span class="hljs-comment"># 拼接下采样的文件夹路径</span><br>        imgdir = os.path.join(datadir,<span class="hljs-string">&quot;images_&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(factor))<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(imgdir):<br>            needtoload = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">for</span> resolution <span class="hljs-keyword">in</span> resolutions:<br>        <span class="hljs-comment"># todo 不懂这个目录是什么目录</span><br>        imgdir = os.path.join(datadir,<span class="hljs-string">&quot;images_&#123;&#125;x&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(resolution[<span class="hljs-number">1</span>],resolution[<span class="hljs-number">0</span>]))<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(imgdir):<br>            needtoload = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 所有目录都有，直接返回</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> needtoload:<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-comment"># 没有下采样数据，从原始数据里面采样</span><br>    <span class="hljs-comment"># 原始img数据目录</span><br>    imgdir = os.path.join(datadir,<span class="hljs-string">&quot;images&quot;</span>)<br>    <span class="hljs-comment"># 获取imgdir下所有的文件</span><br>    imgs =   [os.path.join(imgdir,file) <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(os.listdir(imgdir))]<br>    <span class="hljs-comment"># 筛选文件，选取后缀名为 [&quot;JPG&quot;,&quot;jpg&quot;,&quot;PNG&quot;,&quot;JPEG&quot;,&quot;PNG&quot;]的图片</span><br>    imgs = [file <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> imgs <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>([file.endswith(ex) <span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;JPG&quot;</span>,<span class="hljs-string">&quot;jpg&quot;</span>,<span class="hljs-string">&quot;PNG&quot;</span>,<span class="hljs-string">&quot;JPEG&quot;</span>,<span class="hljs-string">&quot;PNG&quot;</span>]])]<br><br>    <span class="hljs-comment"># 拷贝一份原始img数据目录路径</span><br>    imgdir_original = imgdir<br><br>    img_workDir = os.getcwd()<br><br>    <span class="hljs-comment"># 创建下采样的工作目录</span><br>    <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> factors+resolutions:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(r,<span class="hljs-built_in">int</span>):<br>            name = <span class="hljs-string">&quot;images_&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(r)<br>            resize_argument = <span class="hljs-string">&quot;&#123;&#125;%&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">100.</span>/r)<br>        <span class="hljs-keyword">else</span>:<br>            name = <span class="hljs-string">&quot;images_&#123;&#125;x&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(r[<span class="hljs-number">1</span>],r[<span class="hljs-number">0</span>])<br>            resize_argument = <span class="hljs-string">&quot;&#123;&#125;x&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(r[<span class="hljs-number">1</span>],r[<span class="hljs-number">0</span>])<br><br>        imgdir  = os.path.join(datadir,name)<br>        <span class="hljs-keyword">if</span> os.path.exists(imgdir):<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Minifying&quot;</span>,r,datadir)<br><br>        <span class="hljs-comment"># 使用subprocess 中 check_output执行shell命令</span><br>        <span class="hljs-comment"># 调用shell完成下采样图片的创建</span><br><br>        os.makedirs(imgdir)<br>        <span class="hljs-comment"># 复制 Imgdir下所有文件到 imgdir_original 备份</span><br>        check_output(<span class="hljs-string">&#x27;cp &#123;&#125;/*&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(imgdir_original,imgdir),shell=<span class="hljs-literal">True</span>)<br>        <span class="hljs-comment"># 获取所用数据集的数据的后缀</span><br>        img_extension = imgs[<span class="hljs-number">0</span>].split(<span class="hljs-string">&#x27;.&#x27;</span>)[-<span class="hljs-number">1</span>]<br><br>        <span class="hljs-comment"># mogrify -format png *.jpg 将文件夹里的所有jpg图片转换为png格式</span><br>        <span class="hljs-comment">#  shell_args 将文件夹里所有img_extension格式的图片转为Png格式并重采样resize为resize_argument里的大小</span><br>        shell_args = <span class="hljs-string">&#x27; &#x27;</span>.join([<span class="hljs-string">&#x27;mogrify&#x27;</span>,<span class="hljs-string">&#x27;-resize&#x27;</span>,resize_argument,<span class="hljs-string">&#x27;-format&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;*.&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(img_extension)])<br>        <span class="hljs-built_in">print</span>(shell_args)<br>        os.chdir()<br>        <span class="hljs-comment">#改变当前工作目录到imgdir （新img文件夹的路径）</span><br>        os.chdir(imgdir)<br>        check_output(shell_args,shell=<span class="hljs-literal">True</span>)<br>        <span class="hljs-comment">#返回最初的IMG文件夹(未下采样、未创建新的)</span><br>        os.chdir(img_workDir)<br><br>        <span class="hljs-comment"># 上一步用mogrify变完之后，如果还有非png格式(img_extension不为png，img_extension格式)的图片，直接删除</span><br>        <span class="hljs-keyword">if</span> img_extension != <span class="hljs-string">&#x27;png&#x27;</span>:<br>            <span class="hljs-comment">#如果拓展不是png 就把所有后缀是png的删掉 因为命令默认是PNG的</span><br>            check_output(<span class="hljs-string">&#x27;rm &#123;&#125;/*.&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(imgdir,img_extension),shell=<span class="hljs-literal">True</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;removed duplicates which are not png&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done&quot;</span>)<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_poses_bds_imgs</span>(<span class="hljs-params">datadir,</span><br><span class="hljs-params">                       factor=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">                       width=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">                       height=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">                       load_imgs = <span class="hljs-literal">True</span></span>):<br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    # 20 x 17 位姿前15个 near far 后两个</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    poses_bounds.npy 文件</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    [ r11 r12 r13 t1 H</span><br><span class="hljs-string">      r21 r22 r23 t2 W    3 x 5  在npy文件里压缩成 --&gt; 1 x 15    [r11 r12 r13 t1 H r21 r22 r23 t2 W r31 r32 r33 t3 f]</span><br><span class="hljs-string">      r31 r32 r33 t3 f]</span><br><span class="hljs-string"></span><br><span class="hljs-string">    相机外参的逆矩阵被称为camera-to-world (c2w)矩阵，其作用是把相机坐标系的点变换到世界坐标系。</span><br><span class="hljs-string">    r11~r33 c2w旋转矩阵</span><br><span class="hljs-string">    t1~t3 c2w平移向量</span><br><span class="hljs-string">    H 照片高度</span><br><span class="hljs-string">    W 照片宽度</span><br><span class="hljs-string">    f 相机焦距</span><br><span class="hljs-string">      </span><br><span class="hljs-string">    最后两个参数用于表示场景的范围Bounds (bds)，是该相机视角下场景点离相机中心最近(near)和最远(far)的距离。</span><br><span class="hljs-string">    [r11 r12 r13 t1 H r21 r22 r23 t2 W r31 r32 r33 t3 f near far]</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    poses_mat = np.load(os.path.join(datadir,<span class="hljs-string">&#x27;poses_bounds.npy&#x27;</span>))<br>    <span class="hljs-comment">#获取相机位姿参数 最后为 3 x 5 x 20 的矩阵</span><br>    <span class="hljs-comment"># 20 x 17 --&gt; 20 x 15 --&gt; 20 x 3 x 5 --&gt; 3 x 5 x 20</span><br>    c2w = poses_mat[:,:-<span class="hljs-number">2</span>].reshape([-<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>]).transpose([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>])<br>    <span class="hljs-comment"># 获取最后两列 near far 数据 作为 bds</span><br>    <span class="hljs-comment"># 20 x 2 --&gt; 20 x 2</span><br>    bds  = poses_mat[:,-<span class="hljs-number">2</span>:].transpose([<span class="hljs-number">1</span>,<span class="hljs-number">0</span>])<br><br>    <span class="hljs-comment"># 获取data目录下的images的第一张，用于计算img的shape</span><br>    img0 = [os.path.join(datadir,<span class="hljs-string">&#x27;images&#x27;</span>,f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(os.listdir(os.path.join(datadir,<span class="hljs-string">&#x27;images&#x27;</span>)))<br>            <span class="hljs-keyword">if</span> f.endswith(<span class="hljs-string">&quot;JPG&quot;</span>) <span class="hljs-keyword">or</span> f.endswith(<span class="hljs-string">&quot;jpg&quot;</span>) <span class="hljs-keyword">or</span> f.endswith(<span class="hljs-string">&quot;png&quot;</span>)][<span class="hljs-number">0</span>]<br>    <span class="hljs-comment"># 获取原始照片的大小</span><br>    raw_imageshape = imageio.imread(img0).shape<br><br>    <span class="hljs-comment"># 下采样的倍数 用来索引下采样的文件夹</span><br>    sfx = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> factor <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        sfx =<span class="hljs-string">&quot;_&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(factor)<br>        <span class="hljs-comment"># 下采样 函数里判断是否以及有了对于的文件夹</span><br>        _minify(datadir,factors=[factor])<br>        <span class="hljs-comment"># 备份factor</span><br>        factor = factor<br>    <span class="hljs-keyword">elif</span> height <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># 如果提供下采样图片高度的话</span><br>        <span class="hljs-comment"># 用指定的高度计算缩放因子，然后计算宽度</span><br>        <span class="hljs-comment"># 然后用指定的高度和宽度进行下采样</span><br>        factor = raw_imageshape[<span class="hljs-number">0</span>]/<span class="hljs-built_in">float</span>[height]<br>        width  = <span class="hljs-built_in">int</span>(raw_imageshape[<span class="hljs-number">1</span>]/factor)<br>        <span class="hljs-comment"># 按指定</span><br>        _minify(datadir,resolutions=[[height,width]])<br>        sfx = <span class="hljs-string">&quot;_&#123;&#125;x&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(width,height)<br>    <span class="hljs-keyword">elif</span> width <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># 如果提供下采样图片宽度的话</span><br>        <span class="hljs-comment"># 用指定的宽度计算缩放因子，然后计算高度</span><br>        <span class="hljs-comment"># 然后用指定的高度和宽度进行下采样</span><br>        factor = raw_imageshape[<span class="hljs-number">1</span>]/<span class="hljs-built_in">float</span>[width]<br>        height = <span class="hljs-built_in">int</span>(raw_imageshape[<span class="hljs-number">0</span>]/factor)<br>        _minify(datadir,resolutions=[[height,width]])<br>        sfx = <span class="hljs-string">&quot;_&#123;&#125;x&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(width,height)<br>    <span class="hljs-keyword">else</span>:<br>        factor = <span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># 判断存放下采样的 img的目录是否存在</span><br>    imgdir = os.path.join(datadir,<span class="hljs-string">&#x27;images&#x27;</span>+sfx)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(imgdir):<br>        <span class="hljs-built_in">print</span>(imgdir,<span class="hljs-string">&quot;does not exists,returning&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-comment"># 获取下采样img文件夹下所有的img</span><br>    imgfiles =[os.path.join(imgdir,file) <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(os.listdir(imgdir)) <span class="hljs-keyword">if</span><br>               file.endswith(<span class="hljs-string">&quot;JPG&quot;</span>) <span class="hljs-keyword">or</span> file.endswith(<span class="hljs-string">&quot;jpg&quot;</span>) <span class="hljs-keyword">or</span> file.endswith(<span class="hljs-string">&quot;png&quot;</span>)]<br><br><br>    <span class="hljs-comment"># 判断位姿文件中所含的img个数与data文件夹中img个数是否相等</span><br>    <span class="hljs-keyword">if</span> c2w.shape[-<span class="hljs-number">1</span>] !=<span class="hljs-built_in">len</span>(imgfiles):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Mismatching between img&#123;&#125; and poses &#123;&#125; ！！！！ &quot;</span>.<span class="hljs-built_in">format</span>((<span class="hljs-built_in">len</span>(imgfiles)),c2w.shape[-<span class="hljs-number">1</span>]))<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-comment"># 获取下采样完照片的尺寸</span><br>    shx_imageshape = imageio.imread(imgfiles[<span class="hljs-number">0</span>]).shape<br><br>    <span class="hljs-comment">#用c2w矩阵 [R T] 矩阵 拼接完整的poses矩阵 [R T hwf]</span><br>    poses = c2w<br>    <span class="hljs-comment"># 每张照片c2w矩阵最后一列放上H、W</span><br>    poses[:<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,:] = np.array(shx_imageshape[:<span class="hljs-number">2</span>]).reshape([<span class="hljs-number">2</span>,<span class="hljs-number">1</span>])<br>    <span class="hljs-comment"># 完成对img的下采样</span><br>    poses[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,:] = c2w[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,:]*<span class="hljs-number">1.0</span>/factor<br><br><br>    <span class="hljs-comment"># 如果不需要加载图片，只返回处理完的poses和bds</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> load_imgs:<br>        <span class="hljs-keyword">return</span> poses,bds<br><br>    <span class="hljs-comment"># RGB通道归一化</span><br>    imgs = [imread(file)[...,:<span class="hljs-number">3</span>]/<span class="hljs-number">255</span> <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> imgfiles]<br>    imgs = np.stack(imgs,-<span class="hljs-number">1</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;load image data&quot;</span>,imgs.shape,poses[:,-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">return</span> poses,bds,imgs<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_llff_data</span>(<span class="hljs-params"></span><br><span class="hljs-params">        datadir,</span><br><span class="hljs-params">        factor=<span class="hljs-number">8</span>,</span><br><span class="hljs-params">        recenter=<span class="hljs-literal">True</span>,</span><br><span class="hljs-params">        bd_factor=<span class="hljs-number">0.75</span>,</span><br><span class="hljs-params">        spherify = <span class="hljs-literal">False</span>,</span><br><span class="hljs-params">        path_zflat=<span class="hljs-literal">False</span></span>):<br>    <span class="hljs-comment"># poses 3 x 5 x 20 bds 2 x 20 imgs 378 x 504 x 3 x 20</span><br>    poses,bds,imgs = get_poses_bds_imgs(datadir,factor)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded&quot;</span>,datadir,bds.<span class="hljs-built_in">min</span>(),bds.<span class="hljs-built_in">max</span>())<br><br>    <span class="hljs-comment"># LLFF相机坐标系-&gt; OpenGL/NeRF坐标系</span><br>    <span class="hljs-comment"># x y z --&gt; y -x z  x变为y y变为-x z不动 按第一个维度N 拼接</span><br>    <span class="hljs-comment"># 3 x 5 x 20</span><br>    poses = np.concatenate([poses[:,<span class="hljs-number">1</span>:<span class="hljs-number">2</span>,:],-poses[:,<span class="hljs-number">0</span>:<span class="hljs-number">1</span>,:],poses[:,<span class="hljs-number">2</span>:,:]],<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># 20 x 3 x 5</span><br>    poses = np.moveaxis(poses,-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>).astype(np.float32)<br>    <span class="hljs-comment"># 374 x 504 x 3 x 20 --&gt;  20 x 374 x 504 x 3</span><br>    imgs = np.moveaxis(imgs,-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>).astype(np.float32)<br>    images = imgs<br>    <span class="hljs-comment"># 20 x 2 --&gt; 2 x 20</span><br>    bds = np.moveaxis(bds,-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>).astype(np.float32)<br><br>    <span class="hljs-comment"># 场景的整体缩放 bd_factor用于调整整体的场景大小</span><br>    sc = <span class="hljs-number">1.0</span> <span class="hljs-keyword">if</span> bd_factor <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1.0</span>/(bds.<span class="hljs-built_in">min</span>() *bd_factor)<br>    <span class="hljs-comment"># 相机位姿的平移向量 x sc 表示将相机的位姿进行缩放或者平移</span><br>    poses[:,:<span class="hljs-number">3</span>,<span class="hljs-number">3</span>] *= sc<br>    <span class="hljs-comment"># 边界缩放</span><br>    bds *= sc<br><br>    <span class="hljs-comment"># todo 重新调整相机的位姿</span><br>    <span class="hljs-keyword">if</span> recenter:<br>        <span class="hljs-comment"># 相机坐标系 -&gt; 世界坐标系</span><br>        <span class="hljs-comment"># 变换后的平均相机位姿的位置处在世界坐标系的原点，XYZ轴朝向和世界坐标系的向一致。</span><br>        poses = recenter_poses(poses)<br><br>    <span class="hljs-keyword">if</span> spherify:<br>        <span class="hljs-comment"># 针对全景360的场景</span><br>        <span class="hljs-comment"># 用于&quot;球面化&quot;相机分布并返回一个环绕的相机轨迹用于新视角合成</span><br>        <span class="hljs-comment"># pose的输 输入的相机参数归一化， render_poses生成一段360度环绕的相机轨迹用于合成新视角</span><br>        poses, render_poses,bds = spherify_poses(poses,bds)<br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># 如果不spherify的话用下面的方法返回一个环绕的相机轨迹用于新视角合成</span><br>        <span class="hljs-comment">#生成渲染的相机姿态矩阵，其中传入中心化后的相机姿态矩阵、上方向向量、半径数组、焦距、zdelta、zrate、旋转次数和环视图数量等参数。</span><br><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        准备参数</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        c2w = poses_average(poses)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;recentered&quot;</span>,c2w.shape)<br>        <span class="hljs-built_in">print</span>(c2w[:<span class="hljs-number">3</span>,:<span class="hljs-number">4</span>])<br><br>        up = normalize(poses[:,:<span class="hljs-number">3</span>,<span class="hljs-number">1</span>].<span class="hljs-built_in">sum</span>(<span class="hljs-number">0</span>))<br><br>        close_depth,inf_depth = bds.<span class="hljs-built_in">min</span>()*<span class="hljs-number">0.9</span>,bds.<span class="hljs-built_in">max</span>()*<span class="hljs-number">5.0</span><br>        dt = <span class="hljs-number">0.75</span><br>        mean_depth = <span class="hljs-number">1.0</span>/(((<span class="hljs-number">1.0</span>-dt)/close_depth+dt/inf_depth))<br>        focal = mean_depth<br><br>        <span class="hljs-comment"># 主要是用来生成一个相机轨迹用于新视角的合成（参数准备）</span><br>        <span class="hljs-comment"># Get radii for spiral path</span><br>        shrink_factor = <span class="hljs-number">.8</span><br>        zdelta = close_depth * <span class="hljs-number">.2</span><br>        tt = poses[:, :<span class="hljs-number">3</span>, <span class="hljs-number">3</span>]  <span class="hljs-comment"># ptstocam(poses[:3,3,:].T, c2w).T</span><br>        rads = np.percentile(np.<span class="hljs-built_in">abs</span>(tt), <span class="hljs-number">90</span>, <span class="hljs-number">0</span>)<br>        c2w_path = c2w<br>        N_views = <span class="hljs-number">120</span><br>        N_rots = <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> path_zflat:<br>            <span class="hljs-comment">#             zloc = np.percentile(tt, 10, 0)[2]</span><br>            zloc = -close_depth * <span class="hljs-number">.1</span><br>            c2w_path[:<span class="hljs-number">3</span>, <span class="hljs-number">3</span>] = c2w_path[:<span class="hljs-number">3</span>, <span class="hljs-number">3</span>] + zloc * c2w_path[:<span class="hljs-number">3</span>, <span class="hljs-number">2</span>]<br>            rads[<span class="hljs-number">2</span>] = <span class="hljs-number">0.</span><br>            N_rots = <span class="hljs-number">1</span><br>            N_views /= <span class="hljs-number">2</span><br><br>        <span class="hljs-comment"># Generate poses for spiral path</span><br>        <span class="hljs-comment"># 非渲染360环绕视频的情况下，假设所有相机都朝向某一个方向(faceforward场景)</span><br>        <span class="hljs-comment"># 生成一段螺旋式的相机轨迹，相机绕着一个轴旋转，其中相机始终注视着一个焦点，相机的up(y)轴保持不变</span><br>        render_poses = render_path_spiral(c2w_path, up, rads, focal, zdelta, zrate=<span class="hljs-number">.5</span>, rots=N_rots, N=N_views)<br><br>    render_poses = np.array(render_poses).astype(np.float32)<br>    c2w = poses_average(poses)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Data:&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(poses.shape, images.shape, bds.shape)<br><br>    dists = np.<span class="hljs-built_in">sum</span>(np.square(c2w[:<span class="hljs-number">3</span>, <span class="hljs-number">3</span>] - poses[:, :<span class="hljs-number">3</span>, <span class="hljs-number">3</span>]), -<span class="hljs-number">1</span>)<br>    i_test = np.argmin(dists)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;HOLDOUT view is&#x27;</span>, i_test)<br><br>    images = images.astype(np.float32)<br>    poses = poses.astype(np.float32)<br><br>    <span class="hljs-keyword">return</span> images, poses, bds, render_poses, i_test<br><br></code></pre></td></tr></table></figure>







<h4 id="opts-py"><a href="#opts-py" class="headerlink" title="opts.py"></a>opts.py</h4><p>定义输入的参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> configargparse<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">config_parser</span>():<br>    parser = configargparse.ArgumentParser()<br><br>    <span class="hljs-comment"># 定义配置文件的位置</span><br>    parser.add_argument(<span class="hljs-string">&quot;--config&quot;</span>,<br>                        is_config_file=<span class="hljs-literal">True</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;config file path&quot;</span>);<br><br>    <span class="hljs-comment"># 定义本次测试的名称，默认为Test01</span><br>    parser.add_argument(<span class="hljs-string">&quot;--expname&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>                        default=<span class="hljs-string">&quot;Test01&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;experiment name&quot;</span>)<br><br>    <span class="hljs-comment"># 定义log文件的路径</span><br>    parser.add_argument(<span class="hljs-string">&quot;--basedir&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>                        default=<span class="hljs-string">&quot;./logs/&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;where to store ckpts and logs&quot;</span>)<br><br>    <span class="hljs-comment"># 定义数据文件的路径</span><br>    parser.add_argument(<span class="hljs-string">&quot;--datadir&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>                        default=<span class="hljs-string">&quot;./data/llff/fern&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;input data directory&quot;</span>)<br><br>    <span class="hljs-comment"># 定义粗网格的深度 全连接层的层数</span><br>    parser.add_argument(<span class="hljs-string">&quot;--netdepth&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">8</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;layers in network&quot;</span>)<br><br>    <span class="hljs-comment"># 定义粗网格的宽度</span><br>    parser.add_argument(<span class="hljs-string">&quot;--netwidth&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">256</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;channels per layer&quot;</span>)<br><br><br>    <span class="hljs-comment"># 定义精细网格的深度 精细网格的全连接层层数</span><br>    parser.add_argument(<span class="hljs-string">&quot;--netdepth_fine&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">8</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;layers in fine network&quot;</span>)<br>    <span class="hljs-comment"># 定义精细网格的宽度</span><br>    parser.add_argument(<span class="hljs-string">&quot;--netwidth_fine&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">256</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;channels per layer in fine network&quot;</span>)<br><br>    <span class="hljs-comment"># batch_size 送去训练的每批光线、像素点的数量</span><br>    parser.add_argument(<span class="hljs-string">&quot;--N_rand&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">32</span>*<span class="hljs-number">32</span>*<span class="hljs-number">4</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;batch size (number of random rays per each gradient step)&quot;</span>)<br><br>    <span class="hljs-comment"># 学习率 lr</span><br>    parser.add_argument(<span class="hljs-string">&quot;--lrate&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>,<br>                        default=<span class="hljs-number">5e-4</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;learnging rate&quot;</span>)<br><br>    <span class="hljs-comment"># 学习率衰减</span><br>    parser.add_argument(<span class="hljs-string">&quot;--lrate_decay&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">250</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;exponential learning decay (in 1000 steps)&quot;</span>)<br><br>    <span class="hljs-comment">#</span><br>    parser.add_argument(<span class="hljs-string">&quot;--chunk&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">1024</span>*<span class="hljs-number">32</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;number of rays processed in parallel , decrease if running out of memory&quot;</span>)<br><br>    <span class="hljs-comment"># 网络中处理的点的数量</span><br>    parser.add_argument(<span class="hljs-string">&quot;--netchunk&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">1024</span>*<span class="hljs-number">64</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;number of pts sent through in parallel,decrease if running out of memory&quot;</span>)<br><br>    <span class="hljs-comment"># 当no_batching设置为 true 时，在每次迭代期间，仅从单个图像中采样整批光线。</span><br>    <span class="hljs-comment"># 当它为 false 时，我们在每次迭代期间从所有图像中采样光线。</span><br>    parser.add_argument(<span class="hljs-string">&quot;--no_batching&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;only take random rays from 1 image at a time&quot;</span>)<br><br>    <span class="hljs-comment"># 不加载权重</span><br>    parser.add_argument(<span class="hljs-string">&quot;--no_reload&quot;</span>,action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;do not reload weights from saved ckpt&quot;</span>)<br>    <span class="hljs-comment"># 粗网络的权重文件</span><br>    parser.add_argument(<span class="hljs-string">&quot;--ft_path&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>                        default=<span class="hljs-literal">None</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;specific weights npy file to reload for coarse netword&quot;</span>)<br><br>    <span class="hljs-comment"># 渲染选项</span><br>    <span class="hljs-comment"># 粗网络中每条光线的采样点</span><br>    parser.add_argument(<span class="hljs-string">&quot;--N_coarse_samples&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">64</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;number of coarse samples per ray&quot;</span>)<br><br>    <span class="hljs-comment"># 精细网络中每条光线的采样点</span><br>    parser.add_argument(<span class="hljs-string">&quot;--N_fine_samples&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">0</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;精细网络中每条光线上采样点的数量&quot;</span>)<br><br>    <span class="hljs-comment"># 设置为 0. 无抖动，1. 抖动</span><br>    parser.add_argument(<span class="hljs-string">&quot;--perturb&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>,<br>                        default=<span class="hljs-number">1.</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;set to 0. for no jitter, 1. for jitter&#x27;</span>)<br><br>    <span class="hljs-comment"># 不使用视角数据</span><br>    parser.add_argument(<span class="hljs-string">&quot;--use_viewdirs&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;use full 5D input instead of 3D&quot;</span>)<br><br>    <span class="hljs-comment"># 0使用位置编码，-1不使用位置编码</span><br>    parser.add_argument(<span class="hljs-string">&quot;--i_embed&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">0</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;set 0 for default positional encoding,-1 for none&quot;</span>)<br><br>    <span class="hljs-comment"># 位置编码的层数</span><br>    parser.add_argument(<span class="hljs-string">&quot;--multires&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">10</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;log2 of max freq for positional encoding 3D locaiton&quot;</span>)<br>    <span class="hljs-comment"># todo 不知道</span><br>    parser.add_argument(<span class="hljs-string">&quot;--multires_views&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">4</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;log2 of max freq for positional encoding 2D direction&quot;</span>)<br><br>    <span class="hljs-comment"># 设置初始噪声</span><br>    parser.add_argument(<span class="hljs-string">&quot;--raw_noise_std&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>,<br>                        default=<span class="hljs-number">0</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;std dev of noise to regularise sigma_a output,1e0 recommended&quot;</span>)<br><br>    <span class="hljs-comment"># 仅对以及跑完的数据进行渲染 不用用数据优化网络</span><br>    parser.add_argument(<span class="hljs-string">&quot;--render_only&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;do not optimize,reload weights and render out render_poses path&quot;</span>)<br><br>    <span class="hljs-comment"># 渲染test数据集</span><br>    parser.add_argument(<span class="hljs-string">&quot;--render_test&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;render the test set instead of render_poses path&quot;</span>)<br>    <span class="hljs-comment"># 下采样的倍数</span><br>    parser.add_argument(<span class="hljs-string">&quot;--render_factor&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">0</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;downsampling factor to speed up rendering,set 4 or 8 for fast previes&quot;</span>)<br><br>    <span class="hljs-comment">#训练的参数</span><br>    <span class="hljs-comment"># 数据的格式</span><br>    parser.add_argument(<span class="hljs-string">&quot;--dataset_type&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>                        default=<span class="hljs-string">&quot;llff&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;options:llff/blender/deepvoxels&quot;</span>)<br><br>    <span class="hljs-comment"># 对于大的数据集，只使用其中一部分数据</span><br>    parser.add_argument(<span class="hljs-string">&quot;--test_skip&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">8</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;will load 1/N images from test/val set,useful for large datasets like deepvoxels&quot;</span>)<br><br>    <span class="hljs-comment"># deepvoxel flags deepvoxel的选项</span><br>    parser.add_argument(<span class="hljs-string">&quot;--shape&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>                        default=<span class="hljs-string">&quot;greek&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;options:armchair/cube/greek,vase&quot;</span>)<br><br>    <span class="hljs-comment">#blender flags Blender的选项</span><br>    <span class="hljs-comment">#白色背景</span><br>    parser.add_argument(<span class="hljs-string">&quot;--white_bkgd&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;set to render synthetic data on a white background (always use for dvoxels)&quot;</span>)<br><br>    <span class="hljs-comment">#使用一半分辨率</span><br>    parser.add_argument(<span class="hljs-string">&quot;--half_res&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;load blender synthetic data at 400*400 instead of 800*800&quot;</span>)<br><br>    <span class="hljs-comment">#llff flags llff的选项</span><br>    <span class="hljs-comment"># 下采样</span><br>    parser.add_argument(<span class="hljs-string">&quot;--factor&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">8</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;downsample factor for LLFF images&quot;</span>)<br><br>    <span class="hljs-comment">#不使用ndc坐标系</span><br>    parser.add_argument(<span class="hljs-string">&quot;--no_ndc&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;do not use normalized device coordinates (set for non-forward facing scenes)&quot;</span>)<br><br>    <span class="hljs-comment"># todo 不知道</span><br>    parser.add_argument(<span class="hljs-string">&quot;--lindisp&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;sampling linearly in disparity rather than depth&quot;</span>)<br><br>    <span class="hljs-comment"># 是否对相机位姿进行球形化</span><br>    parser.add_argument(<span class="hljs-string">&quot;--spherify&quot;</span>,<br>                        action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;set for spherical 360 scenes&quot;</span>)<br><br>    <span class="hljs-comment"># 对于大的数据集，只使用其中一部分数据</span><br>    parser.add_argument(<span class="hljs-string">&quot;--llffhold&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">8</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;will take every 1/N images as LLFF data test set,paper uses 8&quot;</span>)<br><br>    <span class="hljs-comment"># logging/saving options</span><br>    <span class="hljs-comment"># log输出的频率</span><br>    parser.add_argument(<span class="hljs-string">&quot;--i_print&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">100</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;frequency of console printout and metric loggin&#x27;</span>)<br><br>    parser.add_argument(<span class="hljs-string">&quot;--i_img&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">500</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;frequency of tensorboard image logging&#x27;</span>)<br>    <span class="hljs-comment"># 保存模型的频率</span><br>    <span class="hljs-comment"># 每隔1w保存一个</span><br>    parser.add_argument(<span class="hljs-string">&quot;--i_weights&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">10000</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;frequency of weight ckpt saving&#x27;</span>)<br><br>    <span class="hljs-comment"># 执行测试集渲染的频率</span><br>    parser.add_argument(<span class="hljs-string">&quot;--i_testset&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">50000</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;frequency of testset saving&#x27;</span>)<br><br>    <span class="hljs-comment"># 执行渲染视频的频率</span><br>    parser.add_argument(<span class="hljs-string">&quot;--i_video&quot;</span>,<br>                        <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>                        default=<span class="hljs-number">50000</span>,<br>                        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;frequency of render_poses video saving&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> parser<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Projects/" class="category-chain-item">Projects</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/NeRF/">#NeRF</a>
      
        <a href="/tags/Python/">#Python</a>
      
        <a href="/tags/DeepLearning/">#DeepLearning</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>NeRF-pytorch源码注释</div>
      <div>https://anonymouslosty.github.io/2023/05/05/NeRF-pytorch源码注释/NeRF-pytorch源码注释/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Ling yi</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年5月5日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2023年5月6日</div>
        </div>
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/10/%E8%87%AA%E5%B7%B1%E7%9A%84%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/%E8%87%AA%E5%B7%B1%E7%9A%84%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="自己的学习环境搭建">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">自己的学习环境搭建</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/04/07/C++%20%E8%BF%9B%E9%98%B6%E7%AC%94%E8%AE%B03/C++%20%E8%BF%9B%E9%98%B6%E7%AC%94%E8%AE%B03/" title="C++ 进阶笔记3">
                        <span class="hidden-mobile">C++ 进阶笔记3</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":true,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
